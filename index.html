<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak Analiz v6 (Kesin Ã‡Ã¶zÃ¼m)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #27ae60; /* Koyu YeÅŸil */
            --highlight-bg: #dff9fb; /* Ã‡ok aÃ§Ä±k mavi (Okunabilirlik iÃ§in) */
            --danger: #c0392b;
            --light: #f1f2f6;
        }

        body { font-family: 'Segoe UI', sans-serif; background: #dfe6e9; padding: 20px; color: #2d3436; }

        /* PANEL TASARIMI */
        .control-panel {
            background: white; padding: 25px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;
            max-width: 1200px; margin-left: auto; margin-right: auto;
        }
        
        .input-group textarea {
            width: 100%; height: 100px; padding: 10px;
            border: 2px solid #eee; border-radius: 5px;
            font-family: monospace; font-size: 12px;
        }

        .btn {
            border: none; padding: 12px 25px; border-radius: 6px;
            cursor: pointer; font-weight: bold; transition: 0.2s;
            color: white; margin-right: 5px;
        }
        .btn-add { background: var(--primary); }
        .btn-add:hover { background: var(--secondary); }
        .btn-report { background: var(--accent); }
        .btn-clear { background: var(--danger); }
        .btn-print { background: #3498db; }

        /* LÄ°STE */
        .portfolio-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px; margin-top: 20px;
            max-height: 300px; overflow-y: auto;
        }
        .item-card {
            background: #fff; padding: 10px; border-radius: 5px;
            border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;
        }

        /* RAPOR ALANI */
        .report-page {
            background: white; width: 100%; max-width: 297mm;
            min-height: 210mm; margin: 0 auto 30px auto;
            padding: 15mm; box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative; box-sizing: border-box;
        }

        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        
        th, td {
            border: 1px solid #b2bec3; padding: 8px;
            text-align: center; vertical-align: middle; word-wrap: break-word;
        }

        /* Sol SÃ¼tun (Ã–zellikler) */
        .col-feature {
            background: var(--primary); color: white; font-weight: bold;
            width: 150px; text-align: left; padding-left: 15px;
        }

        /* BaÅŸlÄ±klar */
        thead th { background: var(--secondary); color: white; height: 50px; position: relative; }

        /* SÄ°LME BUTONU (X) */
        .del-col {
            position: absolute; top: -10px; right: -10px;
            background: var(--danger); color: white;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 12px; border: 2px solid white;
        }

        /* --- KRÄ°TÄ°K BÃ–LÃœM: RENKLENDÄ°RME --- */
        
        /* 1. DÃœÅÃœK FÄ°YAT & BÄ°RÄ°M FÄ°YAT & YAÅ (YEÅÄ°L) */
        .highlight-green {
            background-color: #d1f2eb !important; /* AÃ§Ä±k Nane YeÅŸili */
            color: #009432 !important; /* Koyu YeÅŸil YazÄ± */
            font-weight: 900 !important;
            border: 2px solid #009432 !important;
        }

        /* 2. BÃœYÃœK M2 (FARKLI YEÅÄ°L) */
        .highlight-blue {
            background-color: #d1f2eb !important; 
            color: #009432 !important;
            font-weight: 900 !important;
            border: 2px solid #009432 !important;
        }

        .icon-badge { display: block; font-size: 14px; margin-bottom: 2px; }

        /* Link Butonu */
        .link-btn {
            display: inline-block; background: #3498db; color: white !important;
            text-decoration: none; padding: 4px 10px; border-radius: 12px;
            font-size: 10px; margin-top: 5px;
        }

        /* DEBUG BÄ°LGÄ°SÄ° */
        .debug-info {
            margin-top: 20px; padding: 10px; background: #ffeaa7; 
            font-size: 11px; color: #d35400; border-radius: 4px; display: none;
        }

        @media print {
            body { background: white; padding: 0; }
            .control-panel, .del-col { display: none !important; }
            .report-page { box-shadow: none; margin: 0; width: 100%; }
            .highlight-green, .highlight-blue { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { size: A4 landscape; margin: 5mm; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <h3>ğŸš€ Gayrimenkul Analiz v6</h3>
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            <p style="margin-top:0; font-size:12px; color:#666;">JSON kodunu yapÄ±ÅŸtÄ±rÄ±n:</p>
            <div class="input-group">
                <textarea id="jsonInput" placeholder='{"basliklar": {...}, "satirlar": [...]}'></textarea>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-add" onclick="addData()">Listeye Ekle (+)</button>
                <span id="msg" style="color: green; font-size: 12px; font-weight: bold;"></span>
            </div>
        </div>
        <div style="flex: 1; min-width: 300px;">
            <div style="display: flex; justify-content: space-between;">
                <p style="margin-top:0; font-size:12px; color:#666;">PortfÃ¶y Listesi:</p>
                <button class="btn btn-clear" style="padding: 5px 10px; font-size:11px;" onclick="clearAll()">Temizle</button>
            </div>
            <div class="portfolio-grid" id="listArea"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-report" onclick="renderReport()">ğŸ“Š Raporla</button>
                <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ PDF Ä°ndir</button>
            </div>
        </div>
    </div>
</div>

<div id="reportContainer"></div>

<script>
    const STORAGE_KEY = 'emlak_v6_final';
    let portfolio = [];

    // --- YÃœKLEME ---
    window.onload = () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) { portfolio = JSON.parse(saved); updateList(); }
    };

    // --- VERÄ° Ä°ÅLEME ---
    function addData() {
        const raw = document.getElementById('jsonInput').value;
        if (!raw.trim()) return alert("LÃ¼tfen kod yapÄ±ÅŸtÄ±rÄ±n.");
        try {
            const data = JSON.parse(raw);
            let count = 0;
            Object.keys(data.basliklar).forEach(key => {
                let item = { 
                    id: Math.random().toString(36).substr(2, 9),
                    title: data.basliklar[key],
                    features: {}
                };
                data.satirlar.forEach(row => {
                    // Ã–zellik isimlerini standartlaÅŸtÄ±r (BoÅŸluklarÄ± temizle)
                    item.features[row.ozellik.trim()] = row[key] || '-';
                });
                portfolio.push(item);
                count++;
            });
            save();
            document.getElementById('jsonInput').value = '';
            document.getElementById('msg').innerText = `âœ“ ${count} ilan eklendi.`;
            setTimeout(() => document.getElementById('msg').innerText = '', 3000);
        } catch (e) {
            alert("HatalÄ± JSON FormatÄ±!");
        }
    }

    function updateList() {
        const area = document.getElementById('listArea');
        area.innerHTML = '';
        portfolio.forEach((item, idx) => {
            let price = item.features['Fiyat'] || '';
            area.innerHTML += `
                <div class="item-card">
                    <div>
                        <input type="checkbox" value="${idx}" checked>
                        <span style="font-weight:bold; font-size:13px;">${item.title}</span>
                        <div style="font-size:11px; color:#666;">${price}</div>
                    </div>
                    <button onclick="removeItem(${idx})" style="background:none; border:none; color:red; cursor:pointer;">ğŸ—‘ï¸</button>
                </div>
            `;
        });
    }

    function removeItem(idx) { portfolio.splice(idx, 1); save(); }
    function clearAll() { if(confirm("TÃ¼mÃ¼ silinsin mi?")) { portfolio = []; save(); document.getElementById('reportContainer').innerHTML=''; } }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(portfolio)); updateList(); }

    // --- PARSER (SayÄ± Okuyucu) ---
    function parseNum(str) {
        if (!str) return 0;
        let s = str.toString();
        // Sadece rakamlarÄ± al, noktayÄ± ve virgÃ¼lÃ¼ yÃ¶net
        // TR format: 1.250.000 (Tam sayÄ±) veya 1.250,50 (OndalÄ±k)
        // Strateji: TÃ¼m noktalarÄ± sil, virgÃ¼lÃ¼ nokta yap.
        s = s.replace(/\./g, '').replace(/,/g, '.');
        let match = s.match(/[0-9.]+/); // SayÄ±sal kÄ±smÄ± Ã§ek
        return match ? parseFloat(match[0]) : 0;
    }

    function parseAge(str) {
        if(!str) return 999;
        let s = str.toString().toLowerCase();
        if(s.includes('sÄ±fÄ±r') || s.includes('yeni') || s.includes('0')) return 0;
        let match = s.match(/\d+/);
        return match ? parseInt(match[0]) : 999;
    }

    // --- RAPOR MOTORU ---
    function renderReport() {
        const selectedIds = Array.from(document.querySelectorAll('#listArea input:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) return alert("SeÃ§im yapÄ±n.");

        const ads = selectedIds.map(i => portfolio[i]);
        const container = document.getElementById('reportContainer');
        container.innerHTML = '';

        // -- ANALÄ°Z (EN Ä°YÄ°LERÄ° BUL) --
        let stats = {
            minPrice: Infinity,
            minUnitPrice: Infinity,
            maxNetM2: 0,
            minAge: 999
        };

        ads.forEach(ad => {
            for (let [key, val] of Object.entries(ad.features)) {
                let k = key.toLowerCase();
                let num = parseNum(val);

                // 1. Fiyat (Sadece 'Fiyat' yazan, Birim olmayan)
                if (key === 'Fiyat' && num > 0) {
                    if (num < stats.minPrice) stats.minPrice = num;
                }
                // 2. Birim Fiyat (Ä°Ã§inde 'birim' geÃ§en)
                else if (k.includes('birim') && num > 0) {
                    if (num < stats.minUnitPrice) stats.minUnitPrice = num;
                }
                // 3. mÂ² (Net Bulma)
                else if (k.includes('mÂ²') || k.includes('m2') || k.includes('metrekare')) {
                    // "160 / 150" formatÄ± varsa saÄŸdakini (Net) al
                    if (val.includes('/')) {
                        let parts = val.split('/');
                        let net = parseNum(parts[1]) || parseNum(parts[0]); // SaÄŸ taraf yoksa solu al
                        if (net > stats.maxNetM2) stats.maxNetM2 = net;
                    } else {
                        if (num > stats.maxNetM2) stats.maxNetM2 = num;
                    }
                }
                // 4. YaÅŸ
                else if (k.includes('yaÅŸ') || k.includes('bina')) {
                    let age = parseAge(val);
                    if (age < stats.minAge) stats.minAge = age;
                }
            }
        });

        // Debug Bilgisi (Gizli kontrol)
        console.log("Analiz Sonucu:", stats);

        // -- SAYFALAMA VE TABLO Ã‡Ä°ZÄ°MÄ° --
        const perPage = 6;
        const totalPages = Math.ceil(ads.length / perPage);

        for (let p = 0; p < totalPages; p++) {
            const pageAds = ads.slice(p * perPage, (p + 1) * perPage);
            const pageDiv = document.createElement('div');
            pageDiv.className = 'report-page';

            let html = `
                <div style="display:flex; justify-content:space-between; border-bottom:3px solid var(--primary); padding-bottom:10px; margin-bottom:20px;">
                    <h1 style="margin:0; color:var(--primary);">DEÄERLEME RAPORU</h1>
                    <div style="text-align:right; font-size:12px;">${new Date().toLocaleDateString('tr-TR')} <br> Sayfa ${p+1}/${totalPages}</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="col-feature">Ã–ZELLÄ°KLER</th>
                            ${pageAds.map(ad => `<th>${ad.title} <div class="del-col" onclick="this.parentElement.cellIndex > 0 && removeCol(this)">âœ•</div></th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            // SatÄ±rlarÄ± OluÅŸtur
            if (pageAds.length > 0) {
                const keys = Object.keys(pageAds[0].features);
                keys.forEach(featName => {
                    html += `<tr><td class="col-feature">${featName}</td>`;
                    
                    pageAds.forEach(ad => {
                        let val = ad.features[featName];
                        let k = featName.toLowerCase();
                        let num = parseNum(val);
                        let cellClass = '';
                        let badge = '';

                        // -- HÃœCRE RENKLENDÄ°RME KARARI --
                        
                        // Fiyat (En DÃ¼ÅŸÃ¼k)
                        if (featName === 'Fiyat' && num === stats.minPrice) {
                            cellClass = 'highlight-green'; badge = '<span class="icon-badge">ğŸ“‰ EN UYGUN</span>';
                        }
                        // Birim Fiyat (En DÃ¼ÅŸÃ¼k)
                        else if (k.includes('birim') && num === stats.minUnitPrice) {
                            cellClass = 'highlight-green'; badge = '<span class="icon-badge">ğŸ’ FIRSAT</span>';
                        }
                        // mÂ² (En BÃ¼yÃ¼k)
                        else if (k.includes('mÂ²') || k.includes('m2') || k.includes('metrekare')) {
                            // Net hesabÄ±
                            let netVal = num;
                            if(val.includes('/')) {
                                let parts = val.split('/');
                                netVal = parseNum(parts[1]) || parseNum(parts[0]);
                            }
                            if (netVal === stats.maxNetM2 && netVal > 0) {
                                cellClass = 'highlight-blue'; badge = '<span class="icon-badge">ğŸ“ EN GENÄ°Å</span>';
                            }
                        }
                        // YaÅŸ (En KÃ¼Ã§Ã¼k)
                        else if ((k.includes('yaÅŸ') || k.includes('bina')) && parseAge(val) === stats.minAge) {
                            cellClass = 'highlight-green'; badge = '<span class="icon-badge">ğŸ†• EN YENÄ°</span>';
                        }

                        // Ä°Ã§erik FormatÄ± (Link mi DÃ¼z mÃ¼?)
                        let content = val;
                        if (k.includes('ilan no') && val.includes('#')) {
                            let id = val.replace('#','').trim();
                            content = `<div>${val}</div><a href="https://sahibinden.com/ilan/${id}/detay" target="_blank" class="link-btn">Ä°lana Git ğŸ”—</a>`;
                        }

                        html += `<td class="${cellClass}">${badge}${content}</td>`;
                    });
                    html += `</tr>`;
                });
            }

            html += `</tbody></table>`;
            
            // Debug Footer
            html += `<div class="debug-info" style="display:block; margin-top:30px; text-align:center; color:#999; background:none;">
                * Sistem Analizi: En Uygun Fiyat: ${stats.minPrice.toLocaleString()} TL | En GeniÅŸ Net: ${stats.maxNetM2} mÂ²
            </div>`;

            pageDiv.innerHTML = html;
            container.appendChild(pageDiv);
        }
    }

    function removeCol(el) {
        const idx = el.parentElement.cellIndex;
        const table = el.closest('table');
        Array.from(table.rows).forEach(row => row.deleteCell(idx));
    }
</script>

</body>
</html>
