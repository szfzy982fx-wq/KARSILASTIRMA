<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portf√∂y Y√∂netim Sistemi (Analizli & S√ºr√ºkle-Bƒ±rak)</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #27ae60;
            --danger: #c0392b;
            --light: #ecf0f1;
            --border: #bdc3c7;
            --btn-link: #3498db;
            --summary-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* --- KONTROL PANELƒ∞ --- */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        h2, h3 { margin-top: 0; color: var(--primary); }

        .input-area textarea {
            width: 100%;
            height: 80px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin-bottom: 10px;
            background: #fafafa;
            box-sizing: border-box;
        }

        /* Butonlar */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; font-size: 11px; padding: 5px 10px; }
        
        .panel-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
        .panel-col { flex: 1; }

        /* S√ºr√ºkle Bƒ±rak Listesi */
        .portfolio-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
        }

        .portfolio-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab; /* S√ºr√ºkleme ikonu */
            transition: transform 0.2s;
        }
        .portfolio-item:active { cursor: grabbing; }
        .portfolio-item.sortable-ghost { opacity: 0.4; background: #d1d8e0; }

        .portfolio-item label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            flex-grow: 1;
        }

        /* --- RAPOR VE ANALƒ∞Z --- */
        .report-section { margin: 0 auto; max-width: 297mm; }
        .report-page {
            padding: 20px 40px;
            background: white;
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            min-height: 190mm;
            position: relative;
        }

        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 800px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; }

        .col-feature {
            width: 140px;
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        /* Piyasa √ñzeti Tablosu Stili */
        .summary-box {
            margin-top: 30px;
            padding: 20px;
            background: var(--summary-bg);
            border: 2px solid var(--primary);
            border-radius: 8px;
        }
        .summary-table { min-width: 100%; margin-top: 10px; background: white; }
        .summary-table th { background: var(--secondary); color: white; }

        .ad-link-btn {
            display: inline-block;
            background-color: var(--btn-link);
            color: white !important;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        .best-price { background-color: #e8f8f5 !important; color: var(--accent) !important; font-weight: 800; border: 2px solid var(--accent); }

        .drag-handle { color: #ccc; margin-right: 5px; font-size: 18px; }

        @media print {
            .control-panel, .page-break, .delete-col-btn { display: none !important; }
            .report-page { box-shadow: none; padding: 10mm; page-break-after: always; }
            @page { size: A4 landscape; margin: 0; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <div class="panel-row">
            <div class="panel-col">
                <h3>1. Veri Giri≈üi (JSON)</h3>
                <div class="input-area">
                    <textarea id="jsonInput" placeholder="Sohbetten aldƒ±ƒüƒ±nƒ±z JSON kodunu buraya yapƒ±≈ütƒ±rƒ±n..."></textarea>
                    <div style="margin-top:5px;">
                        <button class="btn btn-primary" onclick="jsonHavuzaEkle()">üì• Havuza Ekle</button>
                        <span id="statusMsg" style="font-size:12px; margin-left:10px; color:green;"></span>
                    </div>
                </div>
            </div>

            <div class="panel-col">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>2. Portf√∂y√ºm (Sƒ±ralamak i√ßin S√ºr√ºkleyin)</h3>
                    <button class="btn btn-danger" onclick="havuzuTemizle()">T√ºm√ºn√º Sil</button>
                </div>
                
                <div id="portfolioList" class="portfolio-list">
                    <div style="color:#999; font-size:12px; padding:10px;">Liste bo≈ü.</div>
                </div>

                <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-success" onclick="raporuOlustur()">üìä Analizli Rapor Olu≈ütur</button>
                    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è PDF ƒ∞ndir</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reportContainer" class="report-section"></div>

    <script>
        let globalPortfolio = []; 
        const STORAGE_KEY = 'emlak_portfoyu_v3_pro';

        window.onload = function() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                globalPortfolio = JSON.parse(savedData);
                renderPortfolioList();
            }
            // S√ºr√ºkle bƒ±rak ba≈ülatma
            const el = document.getElementById('portfolioList');
            Sortable.create(el, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function() {
                    reorderPortfolio();
                }
            });
        };

        function reorderPortfolio() {
            const items = document.querySelectorAll('.portfolio-item');
            let newOrder = [];
            items.forEach(item => {
                const index = item.getAttribute('data-index');
                newOrder.push(globalPortfolio[index]);
            });
            globalPortfolio = newOrder;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
            renderPortfolioList(); // ƒ∞ndeksleri g√ºncellemek i√ßin tekrar √ßiz
        }

        function jsonHavuzaEkle() {
            const rawJson = document.getElementById('jsonInput').value;
            if (!rawJson.trim()) return;
            try {
                const data = JSON.parse(rawJson);
                const keys = Object.keys(data.basliklar);
                keys.forEach(key => {
                    let newAd = { id: Date.now() + Math.random(), baslik: data.basliklar[key], ozellikler: {} };
                    data.satirlar.forEach(row => { newAd.ozellikler[row.ozellik] = row[key] || '-'; });
                    globalPortfolio.push(newAd);
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
                document.getElementById('jsonInput').value = '';
                renderPortfolioList();
            } catch (e) { alert("Hatalƒ± JSON!"); }
        }

        function renderPortfolioList() {
            const listEl = document.getElementById('portfolioList');
            listEl.innerHTML = '';
            globalPortfolio.forEach((ilan, index) => {
                const item = document.createElement('div');
                item.className = 'portfolio-item';
                item.setAttribute('data-index', index);
                let fiyat = ilan.ozellikler['Fiyat'] || '';
                item.innerHTML = `
                    <span class="drag-handle">‚ò∞</span>
                    <label>
                        <input type="checkbox" value="${index}" checked>
                        <span>${ilan.baslik} <small style="color:#666">(${fiyat})</small></span>
                    </label>
                    <button class="btn btn-danger" onclick="ilaniSil(${index})">Sil</button>
                `;
                listEl.appendChild(item);
            });
        }

        function ilaniSil(index) {
            globalPortfolio.splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
            renderPortfolioList();
        }

        function havuzuTemizle() {
            if(confirm('Hepsi silinecek?')) {
                globalPortfolio = [];
                localStorage.removeItem(STORAGE_KEY);
                renderPortfolioList();
            }
        }

        // --- GELƒ∞≈ûMƒ∞≈û ANALƒ∞Z VE RAPORLAMA ---
        function raporuOlustur() {
            const checkboxes = document.querySelectorAll('#portfolioList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) return;

            const selectedAds = Array.from(checkboxes).map(cb => globalPortfolio[cb.value]);
            const container = document.getElementById('reportContainer');
            container.innerHTML = '';

            // 1. Tabloyu Olu≈ütur (Mevcut mantƒ±k)
            const pageDiv = document.createElement('div');
            pageDiv.className = 'report-page';
            pageDiv.innerHTML = `<h1 style="color:var(--primary); border-bottom:3px solid var(--primary)">Pƒ∞YASA ANALƒ∞Z RAPORU</h1>`;
            
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-wrapper';
            const table = document.createElement('table');
            
            // Ba≈ülƒ±klar ve Satƒ±rlar (Basitle≈ütirilmi≈ü d√∂ng√º)
            let html = `<thead><tr><th class="col-feature">√ñZELLƒ∞KLER</th>`;
            selectedAds.forEach(ad => html += `<th>${ad.baslik}</th>`);
            html += `</tr></thead><tbody>`;

            const featureKeys = Object.keys(selectedAds[0].ozellikler);
            featureKeys.forEach(key => {
                html += `<tr><td class="col-feature">${key}</td>`;
                selectedAds.forEach(ad => {
                    let val = ad.ozellikler[key];
                    html += `<td>${val}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody>`;
            table.innerHTML = html;
            tableWrapper.appendChild(table);
            pageDiv.appendChild(tableWrapper);

            // 2. Pƒ∞YASA √ñZETƒ∞ (Yeni √ñzellik)
            const analiz = analizHesapla(selectedAds);
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'summary-box';
            summaryDiv.innerHTML = `
                <h3 style="color:var(--primary); margin-bottom:15px;">üìä Piyasa Analiz √ñzeti (Se√ßili ${selectedAds.length} ƒ∞lan)</h3>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Kriter</th>
                            <th>En D√º≈ü√ºk</th>
                            <th>En Y√ºksek</th>
                            <th>Ortalama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><b>Toplam Fiyat</b></td>
                            <td>${formatPara(analiz.minFiyat)} TL</td>
                            <td>${formatPara(analiz.maxFiyat)} TL</td>
                            <td style="background:#eef2f3"><b>${formatPara(analiz.avgFiyat)} TL</b></td>
                        </tr>
                        <tr>
                            <td><b>Birim Fiyat (m¬≤)</b></td>
                            <td>${formatPara(analiz.minBirim)} TL</td>
                            <td>${formatPara(analiz.maxBirim)} TL</td>
                            <td style="background:#eef2f3"><b>${formatPara(analiz.avgBirim)} TL</b></td>
                        </tr>
                    </tbody>
                </table>
                <p style="margin-top:15px; font-size:12px; color:#666;">
                    * Ortalama deƒüerler, u√ß veriler temizlenerek hesaplanmƒ±≈ütƒ±r. Bu rapor piyasa tahmini niteliƒüindedir.
                </p>
            `;
            pageDiv.appendChild(summaryDiv);
            container.appendChild(pageDiv);
        }

        function analizHesapla(ads) {
            let fiyatlar = [], birimler = [];
            
            ads.forEach(ad => {
                let f = parseFloat(ad.ozellikler['Fiyat']?.replace(/\./g, '').replace(/[^0-9.]/g, ''));
                let b = parseFloat(ad.ozellikler['Birim Fiyat (Net m¬≤)']?.replace(/\./g, '').replace(/[^0-9.]/g, ''));
                if(!isNaN(f)) fiyatlar.push(f);
                if(!isNaN(b)) birimler.push(b);
            });

            const avg = arr => arr.length ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;

            return {
                minFiyat: Math.min(...fiyatlar),
                maxFiyat: Math.max(...fiyatlar),
                avgFiyat: avg(fiyatlar),
                minBirim: Math.min(...birimler),
                maxBirim: Math.max(...birimler),
                avgBirim: avg(birimler)
            };
        }

        function formatPara(val) {
            return new Intl.NumberFormat('tr-TR').format(Math.round(val));
        }
    </script>
</body>
</html>
