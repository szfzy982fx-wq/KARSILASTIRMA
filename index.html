<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak Analiz v10 (Kesin Final)</title>
    <style>
        :root {
            --primary: #2c3e50; /* Lacivert */
            --secondary: #34495e;
            --accent: #27ae60; /* Ye≈üil */
            --danger: #c0392b; /* Kƒ±rmƒ±zƒ± */
            --btn-link: #3498db; /* Mavi Buton */
            --light: #ecf0f1;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; margin: 0; padding: 20px; color: #333; }

        /* PANEL */
        .control-panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; max-width: 1200px; margin-left: auto; margin-right: auto; }
        .input-group textarea { width: 100%; height: 90px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 11px; box-sizing: border-box; }
        
        .btn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; color: white; margin-right: 5px; }
        .btn-add { background: var(--primary); }
        .btn-report { background: var(--accent); }
        .btn-clear { background: var(--danger); }
        .btn-print { background: #2980b9; }

        /* Lƒ∞STE */
        .portfolio-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .item-card { background: white; padding: 10px; border: 1px solid #ddd; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }

        /* RAPOR */
        .report-page { background: white; width: 100%; max-width: 297mm; min-height: 190mm; margin: 0 auto 30px auto; padding: 15mm; position: relative; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid #bdc3c7; padding: 10px; text-align: center; vertical-align: middle; word-wrap: break-word; }
        
        .col-feature { background: var(--primary); color: white; font-weight: bold; width: 140px; text-align: left; padding-left: 15px; position: sticky; left: 0; z-index: 5; }
        thead th { background: var(--secondary); color: white; height: 50px; position: relative; }
        
        /* Sƒ∞LME BUTONU */
        .del-col { position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; z-index: 10; font-size: 12px; }

        /* --- BUTON (MAVƒ∞ VE GENƒ∞≈û) --- */
        .go-btn {
            display: block; width: 80%; margin: 5px auto 0 auto;
            background-color: var(--btn-link); color: white !important;
            text-decoration: none; padding: 8px 0; border-radius: 20px;
            font-size: 11px; font-weight: bold; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .go-btn:hover { background-color: #2980b9; transform: translateY(-2px); }

        /* --- YE≈ûƒ∞L VURGULAMA --- */
        .winner {
            background-color: #d1f2eb !important; /* Ye≈üil Zemin */
            color: #009432 !important; /* Koyu Ye≈üil Yazƒ± */
            font-weight: 800 !important;
            border: 2px solid #009432 !important;
            position: relative;
        }
        .badge { display: block; font-size: 9px; color: #009432; font-weight: 900; margin-bottom: 2px; }

        @media print {
            .control-panel, .del-col { display: none !important; }
            .report-page { margin: 0; padding: 5mm; width: 100%; max-width: 100%; box-shadow: none; }
            .go-btn { border: 1px solid var(--primary); background: none; color: var(--primary) !important; box-shadow: none; }
            .winner { background-color: #f0fff4 !important; border-width: 1px; }
            @page { size: A4 landscape; margin: 5mm; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            <h3>1. Veri Giri≈üi</h3>
            <div class="input-group"><textarea id="jsonInput" placeholder='JSON kodunu buraya yapƒ±≈ütƒ±rƒ±n...'></textarea></div>
            <button class="btn btn-add" onclick="addData()" style="margin-top:10px;">üì• Ekle</button>
            <span id="msg" style="color:green; font-size:12px; margin-left:10px;"></span>
        </div>
        <div style="flex: 1; min-width: 300px;">
            <div style="display:flex; justify-content:space-between;"><h3>2. Portf√∂y</h3><button class="btn btn-clear" onclick="clearAll()">üóëÔ∏è Temizle</button></div>
            <div class="portfolio-list" id="listArea"><div style="color:#999; padding:5px; font-size:12px;">Bo≈ü</div></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-report" onclick="renderReport()">üìä Raporla</button>
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è PDF ƒ∞ndir</button>
            </div>
        </div>
    </div>
</div>

<div id="reportContainer">
    <div style="text-align:center; padding:50px; color:#999; border: 2px dashed #ddd; margin: 20px auto; max-width: 800px;">Rapor bekleniyor...</div>
</div>

<script>
    const STORAGE_KEY = 'emlak_v10_fix';
    let portfolio = [];

    window.onload = () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) { portfolio = JSON.parse(saved); updateList(); }
    };

    function addData() {
        try {
            const data = JSON.parse(document.getElementById('jsonInput').value);
            let count = 0;
            Object.keys(data.basliklar).forEach(key => {
                let item = { id: Math.random().toString(36), title: data.basliklar[key], features: {} };
                data.satirlar.forEach(row => { item.features[row.ozellik.trim()] = row[key] || '-'; });
                portfolio.push(item); count++;
            });
            save();
            document.getElementById('jsonInput').value = '';
            document.getElementById('msg').innerText = `‚úì ${count} eklendi`;
            setTimeout(()=>document.getElementById('msg').innerText='', 2000);
        } catch(e) { alert("Hatalƒ± JSON"); }
    }

    function updateList() {
        const area = document.getElementById('listArea'); area.innerHTML = '';
        portfolio.forEach((item, idx) => {
            area.innerHTML += `<div class="item-card"><label><input type="checkbox" value="${idx}" checked> <b>${item.title}</b></label><button onclick="del(${idx})" style="border:none; color:red; cursor:pointer;">‚úï</button></div>`;
        });
    }

    function del(idx) { portfolio.splice(idx, 1); save(); }
    function clearAll() { if(confirm("Silinsin mi?")){ portfolio=[]; save(); document.getElementById('reportContainer').innerHTML=''; } }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(portfolio)); updateList(); }

    // --- PARSER (Sayƒ± Okuyucu) ---
    function parseTR(str) {
        if(!str) return 0;
        let s = str.toString().replace(/\./g,'').replace(/,/g,'.'); // 1.250,00 -> 1250.00
        let m = s.match(/[0-9.]+/);
        return m ? parseFloat(m[0]) : 0;
    }
    
    function parseAge(str) {
        if(!str) return 999;
        let s = str.toString().toLowerCase();
        if(s.includes('sƒ±fƒ±r')||s.includes('yeni')||s.includes('0')) return 0;
        let m = s.match(/\d+/);
        return m ? parseInt(m[0]) : 999;
    }

    // --- RAPOR MOTORU ---
    function renderReport() {
        const selIds = Array.from(document.querySelectorAll('#listArea input:checked')).map(cb => cb.value);
        if(selIds.length===0) return alert("Se√ßim yapƒ±n");
        
        const ads = selIds.map(i => portfolio[i]);
        const container = document.getElementById('reportContainer'); container.innerHTML = '';
        
        // ƒ∞STATƒ∞STƒ∞K HESAPLA
        let stats = { minPrice: Infinity, minUnit: Infinity, maxNet: 0, minAge: 999 };

        ads.forEach(ad => {
            for(let [k, v] of Object.entries(ad.features)) {
                let key = k.toLowerCase();
                let num = parseTR(v);
                
                // Fiyat (En D√º≈ü√ºk)
                if(k === 'Fiyat' && num > 0 && num < stats.minPrice) stats.minPrice = num;
                
                // Birim Fiyat (En D√º≈ü√ºk)
                if(key.includes('birim') && num > 0 && num < stats.minUnit) stats.minUnit = num;
                
                // Net m2 (En Y√ºksek) - Slash'ƒ±n saƒüƒ±na bak
                if(key.includes('m¬≤') || key.includes('metrekare')) {
                    let net = num; 
                    if(v.includes('/')) { // "150 / 135" -> 135 al
                        let parts = v.split('/');
                        let p2 = parseTR(parts[1]);
                        if(p2 > 0) net = p2; 
                    }
                    if(net > stats.maxNet) stats.maxNet = net;
                }
                
                // Ya≈ü (En Gen√ß)
                if((key.includes('ya≈ü') || key.includes('bina')) && parseAge(v) < stats.minAge) stats.minAge = parseAge(v);
            }
        });

        const perPage = 6;
        const totalPages = Math.ceil(ads.length/perPage);

        for(let p=0; p<totalPages; p++) {
            const pageAds = ads.slice(p*perPage, (p+1)*perPage);
            let html = `<div class="report-page">
                <div style="border-bottom:3px solid var(--primary); padding-bottom:10px; margin-bottom:20px; display:flex; justify-content:space-between;">
                    <h1 style="margin:0; color:var(--primary);">DEƒûERLEME RAPORU</h1>
                    <div style="font-size:12px; text-align:right;">${new Date().toLocaleDateString('tr-TR')} <br> Sayfa ${p+1}/${totalPages}</div>
                </div>
                <table><thead><tr><th class="col-feature">√ñZELLƒ∞KLER</th>`;
            
            pageAds.forEach(ad => html += `<th>${ad.title} <div class="del-col" onclick="remCol(this)">‚úï</div></th>`);
            html += `</tr></thead><tbody>`;

            if(pageAds.length > 0) {
                Object.keys(pageAds[0].features).forEach(feat => {
                    html += `<tr><td class="col-feature">${feat}</td>`;
                    pageAds.forEach(ad => {
                        let val = ad.features[feat];
                        let key = feat.toLowerCase();
                        let num = parseTR(val);
                        let cls = ''; let badge = '';

                        // RENKLENDƒ∞RME KONTROL√ú
                        // 1. Fiyat
                        if(feat === 'Fiyat' && num === stats.minPrice) { cls = 'winner'; badge='<span class="badge">üìâ EN UYGUN</span>'; }
                        
                        // 2. Birim Fiyat
                        else if(key.includes('birim') && num === stats.minUnit) { cls = 'winner'; badge='<span class="badge">üíé FIRSAT</span>'; }
                        
                        // 3. Net m2
                        else if(key.includes('m¬≤') || key.includes('metrekare')) {
                            let net = num;
                            if(val.includes('/')) { let p2 = parseTR(val.split('/')[1]); if(p2>0) net=p2; }
                            if(net === stats.maxNet && net > 0) { cls = 'winner'; badge='<span class="badge">üìê EN GENƒ∞≈û</span>'; }
                        }
                        
                        // 4. Ya≈ü
                        else if((key.includes('ya≈ü')||key.includes('bina')) && parseAge(val) === stats.minAge) { cls = 'winner'; badge='<span class="badge">üÜï EN YENƒ∞</span>'; }

                        // BUTON KONTROL√ú (ƒ∞lan No)
                        let content = val;
                        if(key.includes('ilan no')) {
                            let cleanId = val.replace(/[^0-9]/g, '');
                            content = `<div style="font-weight:bold; color:#555;">${val}</div>`;
                            if(cleanId.length > 5) {
                                content += `<a href="https://www.sahibinden.com/ilan/${cleanId}/detay" target="_blank" class="go-btn">ƒ∞lana Git üîó</a>`;
                            }
                        }

                        html += `<td class="${cls}">${badge}${content}</td>`;
                    });
                    html += `</tr>`;
                });
            }
            html += `</tbody></table></div>`;
            container.innerHTML += html;
        }
    }

    function remCol(btn) {
        let idx = btn.parentElement.cellIndex;
        let tbl = btn.closest('table');
        Array.from(tbl.rows).forEach(r => r.deleteCell(idx));
    }
</script>

</body>
</html>
