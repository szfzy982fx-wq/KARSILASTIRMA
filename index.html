<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortfÃ¶y YÃ¶netim ve KarÅŸÄ±laÅŸtÄ±rma Sistemi</title>
    <style>
        :root {
            --primary: #2c3e50; /* Lacivert */
            --secondary: #34495e;
            --accent: #27ae60; /* YeÅŸil */
            --danger: #c0392b; /* KÄ±rmÄ±zÄ± */
            --light: #ecf0f1;
            --border: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* --- KONTROL PANELÄ° (Ekranda gÃ¶rÃ¼nÃ¼r, baskÄ±da gizlenir) --- */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        h2, h3 { margin-top: 0; color: var(--primary); }

        /* JSON GiriÅŸ AlanÄ± */
        .input-area textarea {
            width: 100%;
            height: 80px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin-bottom: 10px;
            background: #fafafa;
        }

        /* Butonlar */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; font-size: 11px; padding: 5px 10px; }
        .btn-outline { border: 1px solid var(--primary); background: transparent; color: var(--primary); }

        /* PortfÃ¶y Listesi (Checkbox AlanÄ±) */
        .portfolio-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
        }

        .portfolio-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .portfolio-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            flex-grow: 1;
        }

        /* --- RAPOR ALANI --- */
        .report-section {
            background: white;
            margin: 0 auto;
            max-width: 297mm; /* A4 Yatay */
        }

        /* Her sayfa (Table Container) */
        .report-page {
            padding: 20px 40px;
            background: white;
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            min-height: 190mm; /* A4'e yakÄ±n */
            position: relative;
        }

        .page-break {
            height: 20px;
            background: #e0e0e0;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
            line-height: 20px;
            color: #666;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Tablo TasarÄ±mÄ± */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed; /* SÃ¼tun geniÅŸliklerini sabitle */
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        /* Ä°lk SÃ¼tun (Ã–zellikler) */
        .col-feature {
            width: 140px;
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            text-align: left;
        }

        /* BaÅŸlÄ±k SatÄ±rÄ± */
        thead th {
            background-color: var(--secondary);
            color: white;
            height: 50px;
            position: relative;
        }

        /* SÃ¼tun Silme Butonu (X) */
        .delete-col-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            border: 2px solid white;
            z-index: 10;
        }
        .delete-col-btn:hover { transform: scale(1.1); }

        /* Vurgulamalar */
        .best-price {
            background-color: #e8f8f5 !important;
            color: var(--accent) !important;
            font-weight: 800;
            border: 2px solid var(--accent);
        }
        
        .ad-link {
            text-decoration: none;
            color: var(--primary);
            font-weight: bold;
            display: block;
            margin-top: 5px;
            font-size: 10px;
        }

        /* --- BASKI AYARLARI (PRINT) --- */
        @media print {
            body { padding: 0; background: white; }
            .control-panel, .page-break { display: none !important; }
            .delete-col-btn { display: none !important; } /* X butonlarÄ±nÄ± gizle */
            
            .report-page {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
                page-break-after: always; /* Her tablodan sonra sayfa kes */
                width: 100%;
                max-width: 100%;
            }
            .report-page:last-child { page-break-after: auto; }

            @page {
                size: A4 landscape;
                margin: 0;
            }
            /* Renkleri zorla */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div style="flex:1; margin-right:20px;">
                <h3>1. Veri GiriÅŸi (JSON)</h3>
                <div class="input-area">
                    <textarea id="jsonInput" placeholder="Sohbetten aldÄ±ÄŸÄ±nÄ±z JSON kodunu buraya yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
                    <button class="btn btn-primary" onclick="jsonHavuzaEkle()">ğŸ“¥ Havuza Ekle</button>
                    <span id="statusMsg" style="font-size:12px; margin-left:10px; color:green;"></span>
                </div>
            </div>
            <div style="flex:1;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>2. PortfÃ¶yÃ¼m (SeÃ§im YapÄ±n)</h3>
                    <button class="btn btn-danger" onclick="havuzuTemizle()">TÃ¼mÃ¼nÃ¼ Sil</button>
                </div>
                <div id="portfolioList" class="portfolio-list">
                    <div style="color:#999; font-size:12px; padding:10px;">HenÃ¼z ilan eklenmedi.</div>
                </div>
                <div style="margin-top:10px; text-align:right;">
                    <button class="btn btn-success" onclick="raporuOlustur()">ğŸ“Š SeÃ§ilenleri Raporla</button>
                </div>
            </div>
        </div>
        
        <div style="border-top:1px solid #eee; margin-top:20px; padding-top:15px; display:flex; justify-content:space-between;">
             <span style="font-size:12px; color:#666;">Ä°pucu: Tabloda istemediÄŸiniz sÃ¼tunu, baÅŸlÄ±ÄŸÄ±ndaki kÄ±rmÄ±zÄ± (X) butonuna basarak kaldÄ±rabilirsiniz.</span>
             <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ PDF Ä°ndir / YazdÄ±r</button>
        </div>
    </div>

    <div id="reportContainer" class="report-section">
        <div style="text-align:center; padding:50px; color:#999;">
            LÃ¼tfen yukarÄ±dan ilanlarÄ± seÃ§ip "Raporla" butonuna basÄ±nÄ±z.
        </div>
    </div>

    <script>
        // --- DEÄÄ°ÅKENLER VE BAÅLANGIÃ‡ ---
        let globalPortfolio = []; // TÃ¼m ilanlarÄ±n tutulduÄŸu hafÄ±za
        const STORAGE_KEY = 'emlak_portfoyu_v1';

        // Sayfa aÃ§Ä±lÄ±nca hafÄ±zayÄ± yÃ¼kle
        window.onload = function() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                globalPortfolio = JSON.parse(savedData);
                renderPortfolioList();
            }
        };

        // --- 1. VERÄ° Ä°ÅLEME (JSON -> OBJE) ---
        function jsonHavuzaEkle() {
            const rawJson = document.getElementById('jsonInput').value;
            if (!rawJson.trim()) { alert("LÃ¼tfen JSON kodu yapÄ±ÅŸtÄ±rÄ±n."); return; }

            try {
                const data = JSON.parse(rawJson);
                // JSON yapÄ±sÄ±: { basliklar: {...}, satirlar: [...] }
                // Bunu her ilan iÃ§in baÄŸÄ±msÄ±z objeye Ã§evirmeliyiz.

                const keys = Object.keys(data.basliklar); // ilan1, ilan2...
                
                let addedCount = 0;
                keys.forEach(key => {
                    // Benzersiz ID oluÅŸtur (zaman damgasÄ± + rastgele)
                    const uniqueId = 'ad_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    // Ä°lan objesi oluÅŸtur
                    let newAd = {
                        id: uniqueId,
                        baslik: data.basliklar[key],
                        ozellikler: {}
                    };

                    // Ã–zellikleri doldur
                    data.satirlar.forEach(row => {
                        newAd.ozellikler[row.ozellik] = row[key] || '-';
                    });

                    // Listeye ekle
                    globalPortfolio.push(newAd);
                    addedCount++;
                });

                // HafÄ±zaya kaydet
                localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
                
                // UI GÃ¼ncelle
                document.getElementById('jsonInput').value = '';
                document.getElementById('statusMsg').textContent = `${addedCount} ilan baÅŸarÄ±yla eklendi!`;
                setTimeout(() => document.getElementById('statusMsg').textContent = '', 3000);
                renderPortfolioList();

            } catch (e) {
                console.error(e);
                alert("JSON HatasÄ±: Kod formatÄ± hatalÄ±. LÃ¼tfen Gemini'den aldÄ±ÄŸÄ±nÄ±z kodu tam kopyaladÄ±ÄŸÄ±nÄ±zdan emin olun.");
            }
        }

        // --- 2. LÄ°STELEME VE SEÃ‡Ä°M ---
        function renderPortfolioList() {
            const listEl = document.getElementById('portfolioList');
            listEl.innerHTML = '';

            if (globalPortfolio.length === 0) {
                listEl.innerHTML = '<div style="color:#999; padding:10px;">Liste boÅŸ.</div>';
                return;
            }

            globalPortfolio.forEach((ilan, index) => {
                const item = document.createElement('div');
                item.className = 'portfolio-item';
                
                // Checkbox varsayÄ±lan olarak seÃ§ili gelsin
                item.innerHTML = `
                    <label>
                        <input type="checkbox" value="${index}" checked>
                        <span>${ilan.baslik}</span>
                        <span style="font-weight:normal; color:#666; font-size:11px;">(${ilan.ozellikler['Fiyat'] || '?'})</span>
                    </label>
                    <button class="btn btn-danger" onclick="ilaniSil(${index})">Sil</button>
                `;
                listEl.appendChild(item);
            });
        }

        function ilaniSil(index) {
            globalPortfolio.splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
            renderPortfolioList();
        }

        function havuzuTemizle() {
            if(confirm('TÃ¼m kayÄ±tlÄ± ilanlar silinecek. Emin misiniz?')) {
                globalPortfolio = [];
                localStorage.removeItem(STORAGE_KEY);
                renderPortfolioList();
                document.getElementById('reportContainer').innerHTML = '';
            }
        }

        // --- 3. RAPOR OLUÅTURMA (PAGINATION MANTIÄI) ---
        function raporuOlustur() {
            // SeÃ§ili ilanlarÄ± bul
            const checkboxes = document.querySelectorAll('#portfolioList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("LÃ¼tfen listeden en az bir ilan seÃ§in.");
                return;
            }

            const selectedAds = [];
            checkboxes.forEach(cb => {
                selectedAds.push(globalPortfolio[cb.value]);
            });

            // En iyi fiyatlarÄ± hesapla (TÃ¼m seÃ§ilenler arasÄ±nda global karÅŸÄ±laÅŸtÄ±rma)
            const globalBestPrices = calculateBestPrices(selectedAds);

            // Container'Ä± temizle
            const container = document.getElementById('reportContainer');
            container.innerHTML = '';

            // --- SAYFALAMA AYARLARI ---
            const ADS_PER_PAGE = 6; // Bir sayfada en fazla 6 ilan
            const totalPages = Math.ceil(selectedAds.length / ADS_PER_PAGE);

            for (let page = 0; page < totalPages; page++) {
                // Sayfa Div'i
                const pageDiv = document.createElement('div');
                pageDiv.className = 'report-page';
                
                // BaÅŸlÄ±k
                const date = new Date().toLocaleDateString('tr-TR');
                pageDiv.innerHTML = `
                    <div style="border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:end;">
                        <div>
                            <h1 style="margin:0; font-size:24px; color:var(--primary);">GAYRÄ°MENKUL DEÄERLEME RAPORU</h1>
                            <div style="color:#7f8c8d; font-size:12px; margin-top:5px;">KARÅILAÅTIRMALI PÄ°YASA ANALÄ°ZÄ° | Sayfa ${page + 1} / ${totalPages}</div>
                        </div>
                        <div style="text-align:right; font-size:12px; color:#666;">Tarih: ${date}</div>
                    </div>
                `;

                // Tablo oluÅŸtur
                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                // O sayfadaki ilanlarÄ± dilimle (Slice)
                const startIdx = page * ADS_PER_PAGE;
                const endIdx = startIdx + ADS_PER_PAGE;
                const pageAds = selectedAds.slice(startIdx, endIdx);

                // --- TABLO BAÅLIÄI (HEADER) ---
                const trHead = document.createElement('tr');
                // Ä°lk sÃ¼tun (BoÅŸ)
                const thFeature = document.createElement('th');
                thFeature.className = 'col-feature';
                thFeature.textContent = 'Ã–ZELLÄ°KLER';
                trHead.appendChild(thFeature);

                pageAds.forEach(ilan => {
                    const th = document.createElement('th');
                    // X Butonu ekle
                    th.innerHTML = `
                        ${ilan.baslik}
                        <div class="delete-col-btn" onclick="sutunuKaldir(this)" title="Bu sÃ¼tunu rapordan kaldÄ±r">âœ•</div>
                    `;
                    trHead.appendChild(th);
                });
                thead.appendChild(trHead);
                table.appendChild(thead);

                // --- TABLO GÃ–VDESÄ° (BODY) ---
                // Ã–zelliklerin listesini almak iÃ§in ilk ilanÄ± referans alabiliriz ama
                // garantili olsun diye tÃ¼m ilanlarÄ±n Ã¶zelliklerini birleÅŸtirip benzersiz liste yapalÄ±m.
                // Basitlik iÃ§in standart bir sÄ±ra belirleyelim veya ilk ilandaki sÄ±rayÄ± kullanalÄ±m.
                // En saÄŸlÄ±klÄ±sÄ±: Ä°lk ilanÄ±n Ã¶zellik sÄ±rasÄ±nÄ± baz almak.
                
                const featureList = Object.keys(pageAds[0].ozellikler);

                featureList.forEach(featKey => {
                    const tr = document.createElement('tr');
                    
                    // Ã–zellik AdÄ±
                    const tdLabel = document.createElement('td');
                    tdLabel.className = 'col-feature';
                    tdLabel.textContent = featKey;
                    tr.appendChild(tdLabel);

                    // Ä°lan DeÄŸerleri
                    pageAds.forEach(ilan => {
                        const td = document.createElement('td');
                        let content = ilan.ozellikler[featKey];
                        
                        // Ä°lan No Linkleme
                        if (featKey === "Ä°lan No" && content.includes("#")) {
                            const cleanId = content.replace('#', '').trim();
                            td.innerHTML = `
                                ${content}
                                <a href="https://www.sahibinden.com/ilan/${cleanId}/detay" target="_blank" class="ad-link">Ä°lana Git ğŸ”—</a>
                            `;
                        } else {
                            td.textContent = content;
                        }

                        // Vurgulama KontrolÃ¼ (Global en iyi fiyat mÄ±?)
                        // Bu ilanÄ±n ID'si global "kazananlar" listesinde var mÄ± ve Ã¶zellik fiyat mÄ±?
                        if ((featKey === 'Fiyat' || featKey.includes('Birim')) && 
                            globalBestPrices[featKey] === parseFloat(content.replace(/\./g,'').replace(/[^0-9.]/g,''))) {
                             td.classList.add('best-price');
                             // Sadece sayÄ±sal eÅŸitlik yetmez, en dÃ¼ÅŸÃ¼k olmalÄ±.
                             // Basitlik iÃ§in: calculateBestPrices fonksiyonu "en dÃ¼ÅŸÃ¼k deÄŸeri" dÃ¶nsÃ¼n.
                             // Biz de buradaki deÄŸeri parse edip karÅŸÄ±laÅŸtÄ±ralÄ±m.
                        }

                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                table.appendChild(tbody);
                pageDiv.appendChild(table);
                container.appendChild(pageDiv);

                // Sayfa arasÄ± boÅŸluk (Son sayfa hariÃ§)
                if (page < totalPages - 1) {
                    const separator = document.createElement('div');
                    separator.className = 'page-break';
                    separator.textContent = '--- Sayfa Sonu ---';
                    container.appendChild(separator);
                }
            }
        }

        // --- YARDIMCI: EN Ä°YÄ° FÄ°YAT HESAPLAMA ---
        function calculateBestPrices(ads) {
            let bests = {}; // { 'Fiyat': 12000000, 'Birim Fiyat': 74000 }
            
            // Kontrol edilecek alanlar
            const keysToCheck = ['Fiyat', 'Birim Fiyat (Net mÂ²)'];

            keysToCheck.forEach(key => {
                let minVal = Infinity;
                ads.forEach(ad => {
                    if (ad.ozellikler[key]) {
                        // "12.500.000 TL" -> 12500000
                        let val = parseFloat(ad.ozellikler[key].replace(/\./g, '').replace(/[^0-9.]/g, ''));
                        if (!isNaN(val) && val > 0 && val < minVal) {
                            minVal = val;
                        }
                    }
                });
                if (minVal !== Infinity) bests[key] = minVal;
            });
            return bests;
        }

        // --- YARDIMCI: SÃœTUN SÄ°LME (DOM ÃœZERÄ°NDEN) ---
        function sutunuKaldir(btn) {
            // Hangi TH iÃ§indeyiz?
            const th = btn.parentElement;
            // Hangi sÃ¼tun sÄ±rasÄ±ndayÄ±z (index)?
            const cellIndex = th.cellIndex;
            // Hangi tablonun iÃ§indeyiz?
            const table = th.closest('table');

            // Tablodaki her satÄ±rÄ± dÃ¶n ve o indexteki hÃ¼creyi sil
            const rows = table.rows;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].cells.length > cellIndex) {
                    rows[i].deleteCell(cellIndex);
                }
            }
            
            // EÄŸer tabloda hiÃ§ ilan kalmadÄ±ysa (sadece Ã¶zellik sÃ¼tunu kaldÄ±ysa), sayfayÄ± komple gizle veya uyar
            if (table.rows[0].cells.length === 1) {
               table.closest('.report-page').style.display = 'none';
               // EÄŸer ara Ã§izgi varsa onu da gizle (basit Ã§Ã¶zÃ¼m)
            }
        }

    </script>
</body>
</html>
