<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak Portf√∂y (Final S√ºr√ºm)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --green: #27ae60; /* Vurgu Rengi */
            --blue: #3498db; /* Buton Rengi */
            --danger: #c0392b;
            --light: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            margin: 0; padding: 20px; color: #333;
        }

        /* --- PANEL --- */
        .control-panel {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
            max-width: 1200px; margin: 0 auto 20px auto;
        }

        .input-group textarea {
            width: 100%; height: 80px; border: 1px solid #bdc3c7;
            border-radius: 4px; padding: 10px; font-family: monospace; font-size: 11px;
            background: #fafafa; box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-weight: 600; font-size: 13px; color: white; margin-right: 5px;
        }
        .btn-add { background: var(--primary); }
        .btn-report { background: var(--green); }
        .btn-clear { background: var(--danger); }
        .btn-print { background: var(--blue); }

        .list-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px; margin-top: 15px; max-height: 250px; overflow-y: auto;
            padding: 10px; background: var(--light); border-radius: 6px;
        }
        .list-item {
            background: white; padding: 10px; border: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; border-radius: 4px;
        }

        /* --- RAPOR --- */
        .report-page {
            background: white; width: 100%; max-width: 297mm; min-height: 190mm;
            margin: 0 auto 30px auto; padding: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        
        .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 800px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; vertical-align: middle; word-wrap: break-word; }

        .col-head {
            background: var(--primary); color: white; font-weight: bold; width: 150px;
            text-align: left; padding-left: 15px; position: sticky; left: 0; z-index: 5;
        }
        thead th { background: var(--secondary); color: white; height: 50px; position: relative; }

        /* Sƒ∞LME BUTONU */
        .del-col {
            position: absolute; top: -8px; right: -8px; background: var(--danger);
            color: white; width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            font-size: 12px; border: 2px solid white; z-index: 10;
        }

        /* --- ƒ∞≈ûTE BU: SEVDƒ∞ƒûƒ∞Nƒ∞Z MAVƒ∞ BUTON --- */
        .ad-link-btn {
            display: inline-block;
            background-color: var(--blue); /* Parlak Mavi */
            color: white !important;
            text-decoration: none;
            padding: 8px 15px; 
            border-radius: 20px;
            margin-top: 8px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
            transition: transform 0.2s;
            width: 80%;
            max-width: 140px;
        }
        .ad-link-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        /* --- VURGULAMA (SADECE YE≈ûƒ∞L) --- */
        .winner {
            background-color: #d1f2eb !important; /* Ye≈üil Zemin */
            color: #009432 !important; /* Ye≈üil Yazƒ± */
            font-weight: 800 !important;
            border: 2px solid #009432 !important;
            position: relative;
        }
        .badge { display: block; font-size: 9px; color: #009432; font-weight: 900; margin-bottom: 3px; }

        @media print {
            .control-panel, .del-col { display: none !important; }
            .report-page { margin: 0; box-shadow: none; padding: 10mm; width: 100%; }
            .ad-link-btn { background: transparent; color: var(--primary) !important; border: 1px solid var(--primary); box-shadow: none; padding: 5px; }
            .winner { background-color: #f0fff4 !important; border-width: 1px; }
            @page { size: A4 landscape; margin: 0; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
        <div style="flex:1; min-width:300px;">
            <h3>1. Veri Giri≈üi</h3>
            <div class="input-group">
                <textarea id="jsonInput" placeholder="JSON kodunu buraya yapƒ±≈ütƒ±rƒ±n..."></textarea>
                <div style="margin-top:10px;">
                    <button class="btn btn-add" onclick="add()">üì• Ekle</button>
                    <span id="msg" style="color:green; font-size:12px; font-weight:bold;"></span>
                </div>
            </div>
        </div>
        <div style="flex:1; min-width:300px;">
            <div style="display:flex; justify-content:space-between;"><h3>2. Liste</h3><button class="btn btn-clear" onclick="clearAll()">Temizle</button></div>
            <div id="list" class="list-grid"><div style="color:#999; padding:10px; font-size:12px;">Liste bo≈ü.</div></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-report" onclick="render()">üìä Raporla</button>
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è PDF ƒ∞ndir</button>
            </div>
        </div>
    </div>
</div>

<div id="reportContainer">
    <div style="text-align:center; padding:50px; color:#999; border: 2px dashed #ddd; margin: 20px auto; max-width: 800px;">Rapor bekleniyor...</div>
</div>

<script>
    const KEY = 'emlak_final_fix';
    let ads = [];

    window.onload = () => {
        let s = localStorage.getItem(KEY);
        if(s) { ads = JSON.parse(s); list(); }
    }

    // --- PARSER ---
    function getNum(v) {
        if(!v) return 0;
        let s = v.toString().replace(/\./g,'').replace(/,/g,'.');
        let m = s.match(/[0-9.]+/);
        return m ? parseFloat(m[0]) : 0;
    }
    
    function getAge(v) {
        if(!v) return 999;
        let s = v.toString().toLowerCase();
        if(s.includes('sƒ±fƒ±r')||s.includes('yeni')||s.includes('0')) return 0;
        let m = s.match(/\d+/);
        return m ? parseInt(m[0]) : 999;
    }

    // --- EKLEME ---
    function add() {
        try {
            const data = JSON.parse(document.getElementById('jsonInput').value);
            Object.keys(data.basliklar).forEach(k => {
                let item = { title: data.basliklar[k], feats: {} };
                data.satirlar.forEach(r => { item.feats[r.ozellik.trim()] = r[k] || '-'; });
                ads.push(item);
            });
            save();
            document.getElementById('jsonInput').value='';
            document.getElementById('msg').innerText = "Eklendi!";
            setTimeout(()=>document.getElementById('msg').innerText='',2000);
        } catch(e) { alert("JSON Hatasƒ±"); }
    }

    function list() {
        const d = document.getElementById('list'); d.innerHTML='';
        ads.forEach((a,i) => {
            let price = a.feats['Fiyat'] || '';
            d.innerHTML += `<div class="list-item"><label><input type="checkbox" value="${i}" checked> <b>${a.title}</b> <small>(${price})</small></label><button onclick="del(${i})" style="color:red;border:none;background:none;cursor:pointer;">‚úï</button></div>`;
        });
    }

    function del(i) { ads.splice(i,1); save(); }
    function clearAll() { if(confirm("Silinsin mi?")){ ads=[]; save(); document.getElementById('reportContainer').innerHTML=''; } }
    function save() { localStorage.setItem(KEY, JSON.stringify(ads)); list(); }

    // --- RAPOR ---
    function render() {
        const sel = Array.from(document.querySelectorAll('#list input:checked')).map(cb=>ads[cb.value]);
        if(sel.length===0) return alert("Se√ßim yapƒ±n");

        // 1. ANALƒ∞Z
        let stats = { minPrice: Infinity, minUnit: Infinity, maxNet: 0, minAge: 999 };

        sel.forEach(ad => {
            for(let [k,v] of Object.entries(ad.feats)) {
                let key = k.toLowerCase();
                let num = getNum(v);

                if(k==='Fiyat' && num>0 && num<stats.minPrice) stats.minPrice = num;
                if(key.includes('birim') && num>0 && num<stats.minUnit) stats.minUnit = num;
                if((key.includes('m¬≤')||key.includes('metrekare')) && (key.includes('br√ºt') || key.includes('net') || key.includes('m2'))) {
                     // Net'i bul (Slash saƒüƒ±)
                     let net = num;
                     if(v.includes('/')) {
                         let parts = v.split('/');
                         let right = getNum(parts[1]);
                         if(right>0) net = right;
                     }
                     if(net > stats.maxNet) stats.maxNet = net;
                }
                if((key.includes('ya≈ü')||key.includes('bina')) && getAge(v)<stats.minAge) stats.minAge = getAge(v);
            }
        });

        const con = document.getElementById('reportContainer'); con.innerHTML='';
        const perPage=6;
        const totalP = Math.ceil(sel.length/perPage);

        for(let p=0; p<totalP; p++) {
            const batch = sel.slice(p*perPage, (p+1)*perPage);
            let h = `<div class="report-page">
                <div style="display:flex; justify-content:space-between; border-bottom:3px solid var(--primary); padding-bottom:10px; margin-bottom:20px;">
                    <div>
                        <h1 style="margin:0; color:var(--primary);">DEƒûERLEME RAPORU</h1>
                        <div style="font-size:12px; color:#666;">Sayfa ${p+1}/${totalP}</div>
                    </div>
                    <div style="font-size:12px;">${new Date().toLocaleDateString('tr-TR')}</div>
                </div>
                <div class="table-wrap">
                <table><thead><tr><th class="col-head">√ñZELLƒ∞KLER</th>`;
            
            batch.forEach(ad => h+=`<th>${ad.title} <div class="del-col" onclick="remCol(this)">‚úï</div></th>`);
            h+=`</tr></thead><tbody>`;

            if(batch.length>0) {
                Object.keys(batch[0].feats).forEach(feat => {
                    h+=`<tr><td class="col-head">${feat}</td>`;
                    batch.forEach(ad => {
                        let val = ad.feats[feat];
                        let key = feat.toLowerCase();
                        let num = getNum(val);
                        let cls = ''; let badge = '';

                        // --- RENKLENDƒ∞RME (HEPSƒ∞ YE≈ûƒ∞L) ---
                        if(feat==='Fiyat' && num===stats.minPrice) { cls='winner'; badge='<span class="badge">üìâ EN UYGUN</span>'; }
                        else if(key.includes('birim') && num===stats.minUnit) { cls='winner'; badge='<span class="badge">üíé FIRSAT</span>'; }
                        else if((key.includes('m¬≤')||key.includes('metrekare'))) {
                            let net = num;
                            if(val.includes('/')) { let r=getNum(val.split('/')[1]); if(r>0) net=r; }
                            if(net===stats.maxNet && net>0) { cls='winner'; badge='<span class="badge">üìê EN GENƒ∞≈û</span>'; }
                        }
                        else if((key.includes('ya≈ü')||key.includes('bina')) && getAge(val)===stats.minAge) { cls='winner'; badge='<span class="badge">üÜï EN YENƒ∞</span>'; }

                        // --- BUTON ---
                        let content = val;
                        // ƒ∞lan No satƒ±rƒ±ysa
                        if(key.includes('ilan no')) {
                            let cleanId = val.replace(/[^0-9]/g,'');
                            content = `<div style="font-weight:bold; color:#555;">${val}</div>`;
                            // Eƒüer ge√ßerli bir ID varsa butonu ekle
                            if(cleanId.length > 5) {
                                content += `<a href="https://www.sahibinden.com/ilan/${cleanId}/detay" target="_blank" class="ad-link-btn">ƒ∞lana Git üîó</a>`;
                            }
                        }

                        h+=`<td class="${cls}">${badge}${content}</td>`;
                    });
                    h+=`</tr>`;
                });
            }
            h+=`</tbody></table></div></div>`;
            con.innerHTML += h;
        }
    }

    function remCol(btn) {
        let idx = btn.parentElement.cellIndex;
        let tbl = btn.closest('table');
        Array.from(tbl.rows).forEach(r => r.deleteCell(idx));
    }
</script>
</body>
</html>
