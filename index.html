<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geli≈ümi≈ü Emlak Portf√∂y Y√∂neticisi</title>
    <style>
        :root {
            --primary: #2c3e50; /* Lacivert */
            --secondary: #34495e;
            --accent: #27ae60; /* Ye≈üil */
            --danger: #c0392b; /* Kƒ±rmƒ±zƒ± */
            --light: #ecf0f1;
            --border: #bdc3c7;
            --btn-link: #2980b9; /* Link Buton Rengi */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* --- KONTROL PANELƒ∞ --- */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        h2, h3 { margin-top: 0; color: var(--primary); }

        /* JSON Giri≈ü Alanƒ± */
        .input-area textarea {
            width: 100%;
            height: 80px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin-bottom: 10px;
            background: #fafafa;
            box-sizing: border-box;
        }

        /* Butonlar */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; font-size: 11px; padding: 5px 10px; }
        
        /* Panel D√ºzeni (Flex) */
        .panel-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }
        .panel-col { flex: 1; }

        /* Portf√∂y Listesi */
        .portfolio-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
        }

        .portfolio-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .portfolio-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            flex-grow: 1;
            overflow: hidden;
        }
        .portfolio-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- RAPOR ALANI --- */
        .report-section {
            margin: 0 auto;
            max-width: 297mm; /* A4 Yatay */
        }

        .report-page {
            padding: 20px 40px;
            background: white;
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            min-height: 190mm;
            position: relative;
            box-sizing: border-box;
        }

        /* Mobil Tablo Kaydƒ±rma */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px; /* Scrollbar payƒ± */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 800px; /* Mobilde b√ºz√º≈ümeyi engeller */
            table-layout: fixed; 
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        .col-feature {
            width: 140px;
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 5;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        thead th {
            background-color: var(--secondary);
            color: white;
            height: 50px;
            position: relative;
        }

        /* S√ºtun Silme Butonu (X) */
        .delete-col-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            border: 2px solid white;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Link Butonu */
        .ad-link-btn {
            display: inline-block;
            background-color: var(--btn-link);
            color: white !important;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 20px;
            margin-top: 6px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            width: 80%;
            max-width: 140px;
        }
        .ad-link-btn:hover {
            background-color: #1f6391;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Vurgulama Stilleri */
        .advantage-cell {
            background-color: #e8f8f5 !important;
            color: var(--accent) !important;
            font-weight: 800;
            border: 2px solid var(--accent);
            position: relative;
        }
        
        /* Kazanan h√ºcrelere minik ikon ekleyelim */
        .advantage-cell::after {
            content: '‚≠ê';
            font-size: 8px;
            position: absolute;
            top: 2px;
            right: 2px;
        }

        .page-break {
            height: 20px;
            background: #e0e0e0;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
            line-height: 20px;
            color: #666;
            font-size: 10px;
        }

        /* --- MOBƒ∞L --- */
        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .control-panel { padding: 15px; }
            .panel-row { flex-direction: column; gap: 20px; }
            .report-page { padding: 15px; min-height: auto; width: 100%; }
            .delete-col-btn { right: -5px; top: -12px; }
        }

        /* --- BASKI --- */
        @media print {
            body { padding: 0; background: white; }
            .control-panel, .page-break, .delete-col-btn { display: none !important; }
            
            .report-page {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
                page-break-after: always;
                width: 100%;
                max-width: 100%;
            }
            .report-page:last-child { page-break-after: auto; }
            
            /* Baskƒ±da scroll olmasƒ±n */
            .table-wrapper { overflow: visible; width: 100%; }
            table { min-width: 100%; width: 100%; table-layout: fixed; }
            
            /* Link butonu sadele≈üsin */
            .ad-link-btn {
                background: transparent;
                color: var(--primary) !important;
                border: 1px solid var(--primary);
                box-shadow: none;
                padding: 4px 8px;
            }
            .advantage-cell { border-width: 1px; background-color: #f0fff4 !important; }

            @page { size: A4 landscape; margin: 0; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <div class="panel-row">
            <div class="panel-col">
                <h3>1. Veri Giri≈üi (JSON)</h3>
                <div class="input-area">
                    <textarea id="jsonInput" placeholder="Sohbetten aldƒ±ƒüƒ±nƒ±z JSON kodunu buraya yapƒ±≈ütƒ±rƒ±n..."></textarea>
                    <div style="margin-top:5px;">
                        <button class="btn btn-primary" onclick="jsonHavuzaEkle()">üì• Havuza Ekle</button>
                        <span id="statusMsg" style="font-size:12px; margin-left:10px; color:green;"></span>
                    </div>
                </div>
            </div>

            <div class="panel-col">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>2. Portf√∂y√ºm</h3>
                    <button class="btn btn-danger" onclick="havuzuTemizle()">T√ºm√ºn√º Sil</button>
                </div>
                
                <div id="portfolioList" class="portfolio-list">
                    <div style="color:#999; font-size:12px; padding:10px;">Liste bo≈ü.</div>
                </div>

                <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-success" onclick="raporuOlustur()">üìä Se√ßilenleri Raporla</button>
                    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è PDF ƒ∞ndir</button>
                </div>
                <div style="margin-top:10px; text-align:right; font-size:11px; color:#666;">
                    * Tabloda s√ºtun ba≈üƒ±ndaki (X) ile gizleme yapabilirsiniz.
                </div>
            </div>
        </div>
    </div>

    <div id="reportContainer" class="report-section">
        <div style="text-align:center; padding:50px; color:#999; border: 2px dashed #ddd; border-radius: 10px;">
            <h3>Rapor Alanƒ±</h3>
            <p>Yukarƒ±dan ilanlarƒ± se√ßip "Se√ßilenleri Raporla" butonuna basƒ±nƒ±z.</p>
        </div>
    </div>

    <script>
        // --- AYARLAR ---
        const STORAGE_KEY = 'emlak_portfoyu_v3_adv';
        let globalPortfolio = []; 

        window.onload = function() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                globalPortfolio = JSON.parse(savedData);
                renderPortfolioList();
            }
        };

        // --- 1. VERƒ∞ EKLEME ---
        function jsonHavuzaEkle() {
            const rawJson = document.getElementById('jsonInput').value;
            if (!rawJson.trim()) { alert("L√ºtfen JSON kodu yapƒ±≈ütƒ±rƒ±n."); return; }

            try {
                const data = JSON.parse(rawJson);
                const keys = Object.keys(data.basliklar); 
                
                let addedCount = 0;
                keys.forEach(key => {
                    const uniqueId = 'ad_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    let newAd = {
                        id: uniqueId,
                        baslik: data.basliklar[key],
                        ozellikler: {}
                    };
                    data.satirlar.forEach(row => {
                        newAd.ozellikler[row.ozellik] = row[key] || '-';
                    });
                    globalPortfolio.push(newAd);
                    addedCount++;
                });

                localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
                document.getElementById('jsonInput').value = '';
                document.getElementById('statusMsg').textContent = `+${addedCount} ƒ∞lan Eklendi`;
                setTimeout(() => document.getElementById('statusMsg').textContent = '', 3000);
                renderPortfolioList();
            } catch (e) {
                console.error(e);
                alert("JSON Hatasƒ±! Kodu eksiksiz kopyaladƒ±ƒüƒ±nƒ±zdan emin olun.");
            }
        }

        // --- 2. Lƒ∞STELEME ---
        function renderPortfolioList() {
            const listEl = document.getElementById('portfolioList');
            listEl.innerHTML = '';

            if (globalPortfolio.length === 0) {
                listEl.innerHTML = '<div style="color:#999; padding:10px;">Liste bo≈ü.</div>';
                return;
            }

            globalPortfolio.forEach((ilan, index) => {
                const item = document.createElement('div');
                item.className = 'portfolio-item';
                let fiyat = ilan.ozellikler['Fiyat'] || '';
                if(fiyat) fiyat = `(${fiyat})`;

                item.innerHTML = `
                    <label>
                        <input type="checkbox" value="${index}" checked>
                        <span><b>${ilan.baslik}</b> <span style="font-weight:normal; color:#666; font-size:11px;">${fiyat}</span></span>
                    </label>
                    <button class="btn btn-danger" onclick="ilaniSil(${index})">Sil</button>
                `;
                listEl.appendChild(item);
            });
        }

        function ilaniSil(index) {
            globalPortfolio.splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
            renderPortfolioList();
        }

        function havuzuTemizle() {
            if(confirm('Kayƒ±tlƒ± t√ºm ilanlar silinecek. Onaylƒ±yor musunuz?')) {
                globalPortfolio = [];
                localStorage.removeItem(STORAGE_KEY);
                renderPortfolioList();
                document.getElementById('reportContainer').innerHTML = '';
            }
        }

        // --- 3. GELƒ∞≈ûMƒ∞≈û HESAPLAMA ---
        // Sayƒ±larƒ± temizlemek i√ßin yardƒ±mcƒ±
        function parseNum(str) {
            if(!str) return 0;
            // T√ºm sayƒ± olmayan karakterleri temizle ama noktayƒ± koru (binlik ayracƒ± ise silinmeli)
            // T√ºrkiye formatƒ±nda nokta binlik, virg√ºl ondalƒ±k olabilir veya tam tersi.
            // Genelde emlak sitelerinde: 12.500.000 (Tam sayƒ±).
            return parseFloat(str.toString().replace(/\./g, '').replace(/[^0-9.]/g, '')) || 0;
        }

        // Bina ya≈üƒ±nƒ± temizlemek i√ßin (ƒ∞lk sayƒ±yƒ± alƒ±r)
        function parseAge(str) {
            if(!str) return 999; // Bilinmiyorsa ya≈ülƒ± sayalƒ±m
            if(str.toLowerCase().includes('sƒ±fƒ±r') || str.includes('0')) return 0;
            const match = str.match(/\d+/); // ƒ∞lk bulduƒüu sayƒ±yƒ± al
            return match ? parseInt(match[0]) : 999;
        }

        function calculateAdvantages(ads) {
            let stats = {
                minPrice: Infinity,
                minUnit: Infinity,
                maxM2: 0,
                minAge: 999
            };

            ads.forEach(ad => {
                // Fiyat
                if (ad.ozellikler['Fiyat']) {
                    let val = parseNum(ad.ozellikler['Fiyat']);
                    if (val > 0 && val < stats.minPrice) stats.minPrice = val;
                }
                // Birim Fiyat
                // Anahtar bazen "Birim Fiyat", bazen "Birim Fiyat (Net m¬≤)" olabilir. ƒ∞√ßinde "Birim" ge√ßeni bulalƒ±m.
                let unitKey = Object.keys(ad.ozellikler).find(k => k.includes('Birim'));
                if (unitKey && ad.ozellikler[unitKey]) {
                    let val = parseNum(ad.ozellikler[unitKey]);
                    if (val > 0 && val < stats.minUnit) stats.minUnit = val;
                }
                // m¬≤ (En B√ºy√ºƒü√º ƒ∞yidir)
                let m2Key = Object.keys(ad.ozellikler).find(k => k.includes('m¬≤') || k.includes('Metrekare'));
                if (m2Key && ad.ozellikler[m2Key]) {
                    // "165 m¬≤ / 145 m¬≤" formatƒ±nda ikinciyi (Net) almaya √ßalƒ±≈üalƒ±m
                    // Eƒüer "/" varsa b√∂l, yoksa direkt al
                    let raw = ad.ozellikler[m2Key];
                    let val = 0;
                    if(raw.includes('/')) {
                        // Genelde Br√ºt / Net -> Net'i (2.yi) alalƒ±m
                        let parts = raw.split('/');
                        val = parseNum(parts[1]) || parseNum(parts[0]);
                    } else {
                        val = parseNum(raw);
                    }
                    if (val > stats.maxM2) stats.maxM2 = val;
                }
                // Bina Ya≈üƒ± (En K√º√ß√ºƒü√º ƒ∞yidir)
                let ageKey = Object.keys(ad.ozellikler).find(k => k.includes('Ya≈ü') || k.includes('Bina'));
                if (ageKey && ad.ozellikler[ageKey]) {
                    let val = parseAge(ad.ozellikler[ageKey]);
                    if (val < stats.minAge) stats.minAge = val;
                }
            });
            return stats;
        }

        // --- 4. RAPOR OLU≈ûTURMA ---
        function raporuOlustur() {
            const checkboxes = document.querySelectorAll('#portfolioList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) { alert("L√ºtfen en az bir ilan se√ßin."); return; }

            const selectedAds = [];
            checkboxes.forEach(cb => { selectedAds.push(globalPortfolio[cb.value]); });

            // Avantajlarƒ± Hesapla
            const bestStats = calculateAdvantages(selectedAds);

            const container = document.getElementById('reportContainer');
            container.innerHTML = '';

            const ADS_PER_PAGE = 6;
            const totalPages = Math.ceil(selectedAds.length / ADS_PER_PAGE);

            for (let page = 0; page < totalPages; page++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'report-page';
                
                const date = new Date().toLocaleDateString('tr-TR');
                pageDiv.innerHTML = `
                    <div style="border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:end; flex-wrap:wrap;">
                        <div>
                            <h1 style="margin:0; font-size:24px; color:var(--primary);">DEƒûERLEME RAPORU</h1>
                            <div style="color:#7f8c8d; font-size:12px; margin-top:5px;">Pƒ∞YASA ANALƒ∞Zƒ∞ | Sayfa ${page + 1} / ${totalPages}</div>
                        </div>
                        <div style="text-align:right; font-size:12px; color:#666; margin-top:10px;">Tarih: ${date}</div>
                    </div>
                `;

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-wrapper';
                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                const startIdx = page * ADS_PER_PAGE;
                const endIdx = startIdx + ADS_PER_PAGE;
                const pageAds = selectedAds.slice(startIdx, endIdx);

                // HEADER
                const trHead = document.createElement('tr');
                const thFeature = document.createElement('th');
                thFeature.className = 'col-feature';
                thFeature.textContent = '√ñZELLƒ∞KLER';
                trHead.appendChild(thFeature);

                pageAds.forEach(ilan => {
                    const th = document.createElement('th');
                    th.innerHTML = `${ilan.baslik} <div class="delete-col-btn" onclick="sutunuKaldir(this)" title="Gizle">‚úï</div>`;
                    trHead.appendChild(th);
                });
                thead.appendChild(trHead);
                table.appendChild(thead);

                // BODY
                if(pageAds.length > 0) {
                    const featureList = Object.keys(pageAds[0].ozellikler);
                    featureList.forEach(featKey => {
                        const tr = document.createElement('tr');
                        
                        const tdLabel = document.createElement('td');
                        tdLabel.className = 'col-feature';
                        tdLabel.textContent = featKey;
                        tr.appendChild(tdLabel);

                        pageAds.forEach(ilan => {
                            const td = document.createElement('td');
                            let content = ilan.ozellikler[featKey];
                            let rawContent = content; // Analiz i√ßin ham hali

                            // Link Butonu
                            if (featKey === "ƒ∞lan No" && content.includes("#")) {
                                const cleanId = content.replace('#', '').trim();
                                td.innerHTML = `
                                    <div style="font-weight:bold; margin-bottom:5px;">${content}</div>
                                    <a href="https://www.sahibinden.com/ilan/${cleanId}/detay" target="_blank" class="ad-link-btn">ƒ∞lana Git üîó</a>
                                `;
                            } else {
                                td.textContent = content;
                            }

                            // --- VURGULAMA MANTIƒûI ---
                            let isBest = false;
                            
                            // 1. Fiyat (En D√º≈ü√ºk)
                            if (featKey === 'Fiyat') {
                                if (parseNum(rawContent) === bestStats.minPrice) isBest = true;
                            }
                            // 2. Birim Fiyat (En D√º≈ü√ºk)
                            else if (featKey.includes('Birim')) {
                                if (parseNum(rawContent) === bestStats.minUnit) isBest = true;
                            }
                            // 3. m¬≤ (En Y√ºksek) - Net'e bakar
                            else if (featKey.includes('m¬≤') || featKey.includes('Metrekare')) {
                                let val = 0;
                                if(rawContent.includes('/')) {
                                    let parts = rawContent.split('/');
                                    val = parseNum(parts[1]) || parseNum(parts[0]);
                                } else {
                                    val = parseNum(rawContent);
                                }
                                if (val === bestStats.maxM2) isBest = true;
                            }
                            // 4. Bina Ya≈üƒ± (En Gen√ß)
                            else if (featKey.includes('Ya≈ü') || featKey.includes('Bina')) {
                                if (parseAge(rawContent) === bestStats.minAge) isBest = true;
                            }

                            if (isBest) td.classList.add('advantage-cell');
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                }

                table.appendChild(tbody);
                tableWrapper.appendChild(table);
                pageDiv.appendChild(tableWrapper);
                container.appendChild(pageDiv);

                if (page < totalPages - 1) {
                    const separator = document.createElement('div');
                    separator.className = 'page-break';
                    separator.textContent = '--- Sayfa Sonu ---';
                    container.appendChild(separator);
                }
            }
        }

        function sutunuKaldir(btn) {
            const th = btn.parentElement;
            const cellIndex = th.cellIndex;
            const table = th.closest('table');
            const rows = table.rows;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].cells.length > cellIndex) rows[i].deleteCell(cellIndex);
            }
            if (table.rows[0].cells.length === 1) table.closest('.report-page').style.display = 'none';
        }
    </script>
</body>
</html>
