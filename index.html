<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portf√∂y Y√∂netim Sistemi (Mobil Uyumlu v11)</title>
    <style>
        :root {
            --primary: #2c3e50; /* Lacivert */
            --secondary: #34495e;
            --accent: #27ae60; /* Ye≈üil */
            --danger: #c0392b; /* Kƒ±rmƒ±zƒ± */
            --light: #ecf0f1;
            --border: #bdc3c7;
            --btn-link: #3498db; /* Link Buton Rengi (Mavi) */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* --- KONTROL PANELƒ∞ --- */
        .control-panel {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
            max-width: 1200px; margin-left: auto; margin-right: auto;
        }

        h2, h3 { margin-top: 0; color: var(--primary); }

        .input-area textarea {
            width: 100%; height: 80px; border: 1px solid var(--border);
            border-radius: 4px; font-family: monospace; font-size: 11px;
            margin-bottom: 10px; background: #fafafa; box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-weight: 600; font-size: 13px; transition: 0.2s; white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; font-size: 11px; padding: 5px 10px; }
        
        .panel-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
        .panel-col { flex: 1; }

        .portfolio-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px; margin-top: 15px; max-height: 300px; overflow-y: auto;
            padding: 10px; background: var(--light); border-radius: 6px;
        }

        .portfolio-item {
            background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-between;
        }
        .portfolio-item label {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            font-size: 13px; font-weight: 600; flex-grow: 1; overflow: hidden;
        }
        .portfolio-item span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- RAPOR ALANI --- */
        .report-section { margin: 0 auto; max-width: 297mm; }

        .report-page {
            padding: 20px 40px; background: white; margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05); min-height: 190mm;
            position: relative; box-sizing: border-box;
        }

        .table-wrapper {
            width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%; border-collapse: collapse; font-size: 12px;
            min-width: 800px; table-layout: fixed; 
        }

        th, td {
            border: 1px solid #ccc; padding: 8px; text-align: center;
            vertical-align: middle; word-wrap: break-word;
        }

        .col-feature {
            width: 140px; background-color: var(--primary); color: white;
            font-weight: bold; text-align: left; position: sticky; left: 0; z-index: 5;
        }

        thead th { background-color: var(--secondary); color: white; height: 50px; position: relative; }

        .delete-col-btn {
            position: absolute; top: -10px; right: -10px; background: var(--danger);
            color: white; border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; border: 2px solid white;
            z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* YENƒ∞: Buton G√∂r√ºn√ºml√º Link */
        .ad-link-btn {
            display: inline-block; background-color: var(--btn-link); color: white !important;
            text-decoration: none; padding: 8px 15px; border-radius: 20px; margin-top: 8px;
            font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s; width: 80%; max-width: 150px;
        }
        .ad-link-btn:hover { background-color: #2980b9; transform: translateY(-2px); }

        /* YE≈ûƒ∞L VURGULAMA */
        .winner {
            background-color: #e8f8f5 !important;
            color: #009432 !important;
            font-weight: 800;
            border: 2px solid #009432;
            position: relative;
        }
        .icon-badge { display: block; font-size: 9px; margin-bottom: 2px; text-transform: uppercase; color: #009432; }

        .page-break {
            height: 20px; background: #e0e0e0; margin: 20px 0; border-radius: 4px;
            text-align: center; line-height: 20px; color: #666; font-size: 10px;
        }

        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .control-panel { padding: 15px; }
            .panel-row { flex-direction: column; gap: 30px; }
            .report-page { padding: 15px; min-height: auto; width: 100%; }
            .col-feature { box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
            .delete-col-btn { right: -5px; top: -12px; }
        }

        @media print {
            body { padding: 0; background: white; }
            .control-panel, .page-break, .delete-col-btn { display: none !important; }
            .report-page { box-shadow: none; margin: 0; padding: 10mm; page-break-after: always; width: 100%; max-width: 100%; }
            .report-page:last-child { page-break-after: auto; }
            .table-wrapper { overflow: visible; width: 100%; }
            table { min-width: 100%; width: 100%; table-layout: fixed; }
            .ad-link-btn {
                background-color: transparent; color: var(--primary) !important;
                border: 1px solid var(--primary); box-shadow: none; padding: 5px 10px;
            }
            .winner { background-color: #f0fff4 !important; border-width: 1px; }
            @page { size: A4 landscape; margin: 0; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <div class="panel-row">
            <div class="panel-col">
                <h3>1. Veri Giri≈üi (JSON)</h3>
                <div class="input-area">
                    <textarea id="jsonInput" placeholder="Sohbetten aldƒ±ƒüƒ±nƒ±z JSON kodunu buraya yapƒ±≈ütƒ±rƒ±n..."></textarea>
                    <div style="margin-top:5px;">
                        <button class="btn btn-primary" onclick="jsonHavuzaEkle()">üì• Havuza Ekle</button>
                        <span id="statusMsg" style="font-size:12px; margin-left:10px; color:green;"></span>
                    </div>
                </div>
            </div>

            <div class="panel-col">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>2. Portf√∂y√ºm</h3>
                    <button class="btn btn-danger" onclick="havuzuTemizle()">T√ºm√ºn√º Sil</button>
                </div>
                
                <div id="portfolioList" class="portfolio-list">
                    <div style="color:#999; font-size:12px; padding:10px;">Liste bo≈ü.</div>
                </div>

                <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-success" onclick="raporuOlustur()">üìä Raporla</button>
                    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è PDF ƒ∞ndir</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reportContainer" class="report-section">
        <div style="text-align:center; padding:50px; color:#999; border: 2px dashed #ddd; border-radius: 10px;">
            <h3>Rapor Alanƒ±</h3>
            <p>Yukarƒ±dan ilanlarƒ± se√ßip "Se√ßilenleri Raporla" butonuna basƒ±nƒ±z.</p>
        </div>
    </div>

    <script>
        // --- AYARLAR ---
        const STORAGE_KEY = 'emlak_v11_mobil';
        let globalPortfolio = []; 

        window.onload = function() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                globalPortfolio = JSON.parse(savedData);
                renderPortfolioList();
            }
        };

        // --- 1. VERƒ∞ ƒ∞≈ûLEME ---
        function jsonHavuzaEkle() {
            const rawJson = document.getElementById('jsonInput').value;
            if (!rawJson.trim()) { alert("L√ºtfen JSON kodu yapƒ±≈ütƒ±rƒ±n."); return; }

            try {
                const data = JSON.parse(rawJson);
                const keys = Object.keys(data.basliklar); 
                let addedCount = 0;
                
                keys.forEach(key => {
                    let newAd = {
                        id: 'ad_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                        baslik: data.basliklar[key],
                        ozellikler: {}
                    };
                    data.satirlar.forEach(row => {
                        newAd.ozellikler[row.ozellik.trim()] = row[key] || '-';
                    });
                    globalPortfolio.push(newAd);
                    addedCount++;
                });

                save();
                document.getElementById('jsonInput').value = '';
                document.getElementById('statusMsg').textContent = `+${addedCount} ƒ∞lan Eklendi`;
                setTimeout(() => document.getElementById('statusMsg').textContent = '', 3000);

            } catch (e) {
                alert("Hatalƒ± JSON formatƒ±!");
            }
        }

        function renderPortfolioList() {
            const listEl = document.getElementById('portfolioList');
            listEl.innerHTML = '';
            if (globalPortfolio.length === 0) {
                listEl.innerHTML = '<div style="color:#999; padding:10px;">Liste bo≈ü.</div>';
                return;
            }
            globalPortfolio.forEach((ilan, index) => {
                let fiyat = ilan.ozellikler['Fiyat'] || '';
                listEl.innerHTML += `
                    <div class="portfolio-item">
                        <label>
                            <input type="checkbox" value="${index}" checked>
                            <span><b>${ilan.baslik}</b> <span style="font-weight:normal; color:#666; font-size:11px;">(${fiyat})</span></span>
                        </label>
                        <button class="btn btn-danger" onclick="ilaniSil(${index})">Sil</button>
                    </div>
                `;
            });
        }

        function ilaniSil(index) { globalPortfolio.splice(index, 1); save(); }
        function havuzuTemizle() { if(confirm('T√ºm ilanlar silinecek?')) { globalPortfolio = []; save(); document.getElementById('reportContainer').innerHTML = ''; } }
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio)); renderPortfolioList(); }

        // --- 2. ANALƒ∞Z MOTORU (Sayƒ± Okuyucu) ---
        function parseNum(str) {
            if (!str) return 0;
            let s = str.toString().replace(/\./g, '').replace(/,/g, '.'); // 1.250 -> 1250
            let match = s.match(/[0-9.]+/);
            return match ? parseFloat(match[0]) : 0;
        }

        function parseAge(str) {
            if(!str) return 999;
            let s = str.toString().toLowerCase();
            if(s.includes('sƒ±fƒ±r') || s.includes('yeni') || s.includes('0')) return 0;
            let match = s.match(/\d+/);
            return match ? parseInt(match[0]) : 999;
        }

        // --- 3. RAPOR VE TABLO OLU≈ûTURMA ---
        function raporuOlustur() {
            const checkboxes = document.querySelectorAll('#portfolioList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) return alert("L√ºtfen se√ßim yapƒ±n.");

            const selectedAds = [];
            checkboxes.forEach(cb => { selectedAds.push(globalPortfolio[cb.value]); });
            
            // ƒ∞STATƒ∞STƒ∞K HESAPLA
            let stats = { minPrice: Infinity, minUnit: Infinity, maxNetM2: 0, minAge: 999 };
            
            selectedAds.forEach(ad => {
                for (let [key, val] of Object.entries(ad.ozellikler)) {
                    let k = key.toLowerCase();
                    let num = parseNum(val);

                    if (key === 'Fiyat' && num > 0 && num < stats.minPrice) stats.minPrice = num;
                    else if (k.includes('birim') && num > 0 && num < stats.minUnit) stats.minUnit = num;
                    else if (k.includes('m¬≤') || k.includes('metrekare')) {
                        let net = num;
                        if(val.includes('/')) { // "150 / 135" -> Saƒüdakini al
                            let parts = val.split('/');
                            let p2 = parseNum(parts[1]);
                            if(p2 > 0) net = p2;
                        }
                        if(net > stats.maxNetM2) stats.maxNetM2 = net;
                    }
                    else if ((k.includes('ya≈ü') || k.includes('bina')) && parseAge(val) < stats.minAge) stats.minAge = parseAge(val);
                }
            });

            const container = document.getElementById('reportContainer');
            container.innerHTML = '';
            const ADS_PER_PAGE = 6;
            const totalPages = Math.ceil(selectedAds.length / ADS_PER_PAGE);

            for (let page = 0; page < totalPages; page++) {
                const pageAds = selectedAds.slice(page * ADS_PER_PAGE, (page + 1) * ADS_PER_PAGE);
                const pageDiv = document.createElement('div');
                pageDiv.className = 'report-page';
                
                let html = `
                    <div style="border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:end;">
                        <div>
                            <h1 style="margin:0; font-size:24px; color:var(--primary);">DEƒûERLEME RAPORU</h1>
                            <div style="color:#7f8c8d; font-size:12px;">Pƒ∞YASA ANALƒ∞Zƒ∞ | Sayfa ${page + 1} / ${totalPages}</div>
                        </div>
                        <div style="font-size:12px;">${new Date().toLocaleDateString('tr-TR')}</div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th class="col-feature">√ñZELLƒ∞KLER</th>
                                    ${pageAds.map(ad => `<th>${ad.baslik} <div class="delete-col-btn" onclick="sutunuKaldir(this)">‚úï</div></th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;

                if(pageAds.length > 0) {
                    const featureList = Object.keys(pageAds[0].ozellikler);
                    featureList.forEach(featKey => {
                        html += `<tr><td class="col-feature">${featKey}</td>`;
                        
                        pageAds.forEach(ad => {
                            let val = ad.ozellikler[featKey];
                            let k = featKey.toLowerCase();
                            let num = parseNum(val);
                            let cls = ''; let badge = '';

                            // RENKLENDƒ∞RME MANTIƒûI
                            if (featKey === 'Fiyat' && num === stats.minPrice) {
                                cls = 'winner'; badge = '<span class="icon-badge">üìâ EN UYGUN</span>';
                            }
                            else if (k.includes('birim') && num === stats.minUnit) {
                                cls = 'winner'; badge = '<span class="icon-badge">üíé FIRSAT</span>';
                            }
                            else if (k.includes('m¬≤') || k.includes('metrekare')) {
                                let net = num;
                                if(val.includes('/')) { let p2 = parseNum(val.split('/')[1]); if(p2>0) net=p2; }
                                if(net === stats.maxNetM2 && net > 0) {
                                    cls = 'winner'; badge = '<span class="icon-badge">üìê EN GENƒ∞≈û</span>';
                                }
                            }
                            else if ((k.includes('ya≈ü') || k.includes('bina')) && parseAge(val) === stats.minAge) {
                                cls = 'winner'; badge = '<span class="icon-badge">üÜï EN YENƒ∞</span>';
                            }

                            // BUTON
                            let content = val;
                            if (k.includes('ilan no') && val.includes('#')) {
                                let cleanId = val.replace(/[^0-9]/g, '');
                                content = `<div style="font-weight:bold; margin-bottom:5px;">${val}</div>`;
                                if(cleanId.length > 5) {
                                    content += `<a href="https://www.sahibinden.com/ilan/${cleanId}/detay" target="_blank" class="ad-link-btn">ƒ∞lana Git üîó</a>`;
                                }
                            }

                            html += `<td class="${cls}">${badge}${content}</td>`;
                        });
                        html += `</tr>`;
                    });
                }

                html += `</tbody></table></div>`;
                pageDiv.innerHTML = html;
                container.appendChild(pageDiv);
            }
        }

        function sutunuKaldir(btn) {
            const th = btn.parentElement;
            const idx = th.cellIndex;
            const table = th.closest('table');
            Array.from(table.rows).forEach(row => { if(row.cells[idx]) row.deleteCell(idx); });
        }
    </script>
</body>
</html>
