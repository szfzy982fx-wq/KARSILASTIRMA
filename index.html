<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak Asistanı (Mobil)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --green: #27ae60;
            --blue: #3498db;
            --bg: #f5f6fa;
        }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }

        /* KONTROL PANELİ */
        .panel { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .btn-add { background: var(--primary); width: 100%; }
        .btn-act { background: var(--green); margin-left: 5px; }
        .btn-del { background: #c0392b; }

        /* LİSTE */
        .list { margin-top: 15px; max-height: 200px; overflow-y: auto; }
        .item { background: white; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }

        /* RAPOR (MOBİL UYUMLU) */
        .report-page { background: white; width: 100%; max-width: 297mm; min-height: 190mm; margin: 20px auto; padding: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.05); box-sizing: border-box; }
        
        /* KAYDIRILABİLİR TABLO */
        .table-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 600px; } /* Mobilde sıkışmasın */
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; }
        
        .sticky-col { position: sticky; left: 0; background: var(--primary); color: white; width: 120px; text-align: left; padding-left: 10px; z-index: 5; }
        thead th { background: var(--secondary); color: white; height: 40px; }

        /* BUTON TASARIMI */
        .link-btn {
            display: inline-block; 
            background-color: var(--blue); 
            color: white !important; 
            text-decoration: none; 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: bold; 
            margin-top: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* VURGULAMA */
        .win { background-color: #d1f2eb !important; border: 2px solid var(--green) !important; font-weight: bold; color: var(--green); }

        /* SİLME İKONU */
        .x-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; }

        @media print {
            .panel, .x-btn { display: none !important; }
            .report-page { margin: 0; box-shadow: none; width: 100%; }
            .link-btn { background: none; color: black !important; border: 1px solid black; }
            .win { background-color: #f0fff4 !important; border: 1px solid black !important; }
            .table-scroll { overflow: visible; }
            @page { size: A4 landscape; margin: 5mm; }
        }
    </style>
</head>
<body>

<div class="panel">
    <h3>1. Veri Girişi</h3>
    <textarea id="jsonInput" placeholder="JSON kodunu buraya yapıştır..."></textarea>
    <button class="btn btn-add" onclick="add()">Listeye Ekle</button>
    <div id="status" style="color:green; font-size:12px; margin-top:5px;"></div>
</div>

<div class="panel">
    <div style="display:flex; justify-content:space-between;">
        <h3>2. Liste</h3>
        <button class="btn btn-del" onclick="clearAll()">Temizle</button>
    </div>
    <div id="list" class="list"></div>
    <div style="margin-top:15px; text-align:right;">
        <button class="btn btn-act" onclick="render()">Raporla</button>
        <button class="btn btn-act" style="background:#2980b9;" onclick="window.print()">Yazdır</button>
    </div>
</div>

<div id="output"></div>

<script>
    let db = [];
    const KEY = 'emlak_mobil_v1';

    window.onload = () => {
        let s = localStorage.getItem(KEY);
        if(s) { db = JSON.parse(s); list(); }
    }

    // SAYI TEMİZLEME
    function num(v) {
        if(!v) return 0;
        let s = v.toString().replace(/\./g,'').replace(/,/g,'.');
        let m = s.match(/[0-9.]+/);
        return m ? parseFloat(m[0]) : 0;
    }

    // YAŞ TEMİZLEME
    function age(v) {
        if(!v) return 999;
        let s = v.toString().toLowerCase();
        if(s.includes('sıfır')||s.includes('yeni')||s.includes('0')) return 0;
        let m = s.match(/\d+/);
        return m ? parseInt(m[0]) : 999;
    }

    function add() {
        try {
            let d = JSON.parse(document.getElementById('jsonInput').value);
            Object.keys(d.basliklar).forEach(k => {
                let item = { t: d.basliklar[k], f: {} };
                d.satirlar.forEach(r => { item.f[r.ozellik.trim()] = r[k] || '-'; });
                db.push(item);
            });
            save();
            document.getElementById('jsonInput').value='';
            document.getElementById('status').innerText = "Eklendi.";
        } catch(e) { alert("JSON Hatası"); }
    }

    function list() {
        let el = document.getElementById('list'); el.innerHTML='';
        db.forEach((i,x) => {
            el.innerHTML += `<div class="item"><label><input type="checkbox" value="${x}" checked> ${i.t}</label> <span onclick="del(${x})" style="color:red;cursor:pointer;">Sil</span></div>`;
        });
    }

    function del(x) { db.splice(x,1); save(); }
    function clearAll() { if(confirm("Sil?")){ db=[]; save(); document.getElementById('output').innerHTML=''; } }
    function save() { localStorage.setItem(KEY, JSON.stringify(db)); list(); }

    function render() {
        let sel = Array.from(document.querySelectorAll('#list input:checked')).map(c => db[c.value]);
        if(sel.length===0) return alert("Seçim yap.");

        // ANALİZ
        let minPrice=Infinity, minUnit=Infinity, maxNet=0, minAge=999;
        sel.forEach(i => {
            for(let [k,v] of Object.entries(i.f)) {
                let key = k.toLowerCase();
                let n = num(v);
                
                if(k==='Fiyat' && n>0 && n<minPrice) minPrice=n;
                if(key.includes('birim') && n>0 && n<minUnit) minUnit=n;
                if((key.includes('m²')||key.includes('metrekare'))) {
                    let net = n;
                    if(v.includes('/')) { let r=num(v.split('/')[1]); if(r>0) net=r; }
                    if(net>maxNet) maxNet=net;
                }
                if((key.includes('yaş')||key.includes('bina')) && age(v)<minAge) minAge=age(v);
            }
        });

        // ÇİZİM
        let out = document.getElementById('output'); out.innerHTML='';
        let perPage = 6;
        let pages = Math.ceil(sel.length/perPage);

        for(let p=0; p<pages; p++) {
            let batch = sel.slice(p*perPage, (p+1)*perPage);
            let h = `<div class="report-page">
                <div style="border-bottom:2px solid #333; margin-bottom:10px; padding-bottom:5px;">
                    <h2 style="margin:0;">DEĞERLEME RAPORU</h2>
                    <small>Sayfa ${p+1}/${pages} - ${new Date().toLocaleDateString('tr-TR')}</small>
                </div>
                <div class="table-scroll">
                <table><thead><tr><th class="sticky-col">ÖZELLİKLER</th>`;
            
            batch.forEach(b => h+=`<th style="position:relative;">${b.t} <div class="x-btn" onclick="remCol(this)">✕</div></th>`);
