<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortfÃ¶y YÃ¶netim ve KarÅŸÄ±laÅŸtÄ±rma Sistemi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50; 
            --secondary: #34495e;
            --accent: #27ae60; 
            --danger: #c0392b; 
            --light: #ecf0f1;
            --border: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* --- KONTROL PANELÄ° --- */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        h2, h3 { margin-top: 0; color: var(--primary); }

        .input-area textarea {
            width: 100%;
            height: 80px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin-bottom: 10px;
            background: #fafafa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; font-size: 11px; padding: 5px 10px; }

        .portfolio-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
        }

        .portfolio-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .portfolio-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            flex-grow: 1;
        }

        /* --- RAPOR ALANI (Dikey ve Ferah Format) --- */
        .report-section {
            background: transparent;
            margin: 0 auto;
            max-width: 210mm; /* A4 Dikey GeniÅŸliÄŸi */
        }

        .report-page {
            padding: 30px;
            background: white;
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            position: relative;
            /* PDF kÃ¼tÃ¼phanesinin sayfalarÄ± ayÄ±rmasÄ± iÃ§in kritik css: */
            page-break-after: always;
        }

        .page-break {
            height: 20px;
            background: #e0e0e0;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
            line-height: 20px;
            color: #666;
            font-size: 10px;
            letter-spacing: 2px;
        }

        /* --- TABLO TASARIMI (Okunabilirlik ArtÄ±rÄ±ldÄ±) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px; /* YazÄ± boyutu bÃ¼yÃ¼tÃ¼ldÃ¼ */
            table-layout: fixed; 
        }

        th, td {
            border: 1px solid #ccc;
            padding: 15px 10px; /* SatÄ±r aralÄ±klarÄ± ferahlatÄ±ldÄ± */
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        .col-feature {
            width: 130px;
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            text-align: left;
            font-size: 13px;
        }

        thead th {
            background-color: var(--secondary);
            color: white;
            height: 60px; /* BaÅŸlÄ±k alanÄ± geniÅŸletildi */
            position: relative;
            font-size: 15px;
        }

        .delete-col-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            border: 2px solid white;
            z-index: 10;
        }

        .best-price {
            background-color: #e8f8f5 !important;
            color: var(--accent) !important;
            font-weight: 800;
            border: 2px solid var(--accent);
            position: relative;
        }
        .best-price::after {
            content: 'â˜…';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 16px;
            color: var(--accent);
        }
        
        /* MÃ¼ÅŸterinin rahatÃ§a tÄ±klayabileceÄŸi belirgin link */
        .ad-link {
            text-decoration: underline;
            color: #2980b9;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            font-size: 12px;
        }

        /* Klasik yazdÄ±rma menÃ¼sÃ¼ engellendi (Ã‡Ã¼nkÃ¼ kendi PDF motorumuzu kullanÄ±yoruz) */
        @media print {
            body::before {
                content: "LÃ¼tfen yazdÄ±r menÃ¼sÃ¼ yerine 'PDF Ä°ndir' butonunu kullanÄ±n!";
                display: block;
                font-size: 20px;
                color: red;
                text-align: center;
                margin-top: 50px;
            }
            .control-panel, .report-section { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div style="flex:1; margin-right:20px;">
                <h3>1. Veri GiriÅŸi (JSON)</h3>
                <div class="input-area">
                    <textarea id="jsonInput" placeholder="Sohbetten aldÄ±ÄŸÄ±nÄ±z JSON kodunu buraya yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
                    <button class="btn btn-primary" onclick="jsonHavuzaEkle()">ğŸ“¥ Havuza Ekle</button>
                    <span id="statusMsg" style="font-size:12px; margin-left:10px; color:green;"></span>
                </div>
            </div>
            <div style="flex:1;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>2. PortfÃ¶yÃ¼m (SeÃ§im YapÄ±n)</h3>
                    <button class="btn btn-danger" onclick="havuzuTemizle()">TÃ¼mÃ¼nÃ¼ Sil</button>
                </div>
                <div id="portfolioList" class="portfolio-list">
                    <div style="color:#999; font-size:12px; padding:10px;">HenÃ¼z ilan eklenmedi.</div>
                </div>
                <div style="margin-top:10px; text-align:right;">
                    <button class="btn btn-success" onclick="raporuOlustur()">ğŸ“Š SeÃ§ilenleri Raporla</button>
                </div>
            </div>
        </div>
        
        <div style="border-top:1px solid #eee; margin-top:20px; padding-top:15px; display:flex; justify-content:space-between; align-items:center;">
             <span style="font-size:12px; color:#666;">Ä°pucu: Ä°stemediÄŸiniz sÃ¼tunu, baÅŸlÄ±ÄŸÄ±ndaki kÄ±rmÄ±zÄ± (X) butonuna basarak gizleyebilirsiniz.</span>
             <button class="btn btn-primary" onclick="pdfIndir()" style="background-color: #8e44ad; font-size: 14px;">ğŸ–¨ï¸ PDF Ä°ndir</button>
        </div>
    </div>

    <div id="reportContainer" class="report-section">
        <div style="text-align:center; padding:50px; color:#999;">
            LÃ¼tfen yukarÄ±dan ilanlarÄ± seÃ§ip "Raporla" butonuna basÄ±nÄ±z.
        </div>
    </div>

    <script>
        let globalPortfolio = []; 
        const STORAGE_KEY = 'emlak_portfoyu_v5';

        window.onload = function() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                globalPortfolio = JSON.parse(savedData);
                renderPortfolioList();
            }
        };

        function jsonHavuzaEkle() {
            const rawJson = document.getElementById('jsonInput').value;
            if (!rawJson.trim()) { alert("LÃ¼tfen JSON kodu yapÄ±ÅŸtÄ±rÄ±n."); return; }

            try {
                const data = JSON.parse(rawJson);
                const keys = Object.keys(data.basliklar); 
                
                let addedCount = 0;
                keys.forEach(key => {
                    const uniqueId = 'ad_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    let newAd = { id: uniqueId, baslik: data.basliklar[key], ozellikler: {} };

                    data.satirlar.forEach(row => {
                        newAd.ozellikler[row.ozellik] = row[key] || '-';
                    });

                    globalPortfolio.push(newAd);
                    addedCount++;
                });

                localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
                document.getElementById('jsonInput').value = '';
                document.getElementById('statusMsg').textContent = `${addedCount} ilan baÅŸarÄ±yla eklendi!`;
                setTimeout(() => document.getElementById('statusMsg').textContent = '', 3000);
                renderPortfolioList();
            } catch (e) {
                console.error(e);
                alert("JSON HatasÄ±: Kod formatÄ± hatalÄ±.");
            }
        }

        function renderPortfolioList() {
            const listEl = document.getElementById('portfolioList');
            listEl.innerHTML = '';

            if (globalPortfolio.length === 0) {
                listEl.innerHTML = '<div style="color:#999; padding:10px;">Liste boÅŸ.</div>';
                return;
            }

            globalPortfolio.forEach((ilan, index) => {
                const item = document.createElement('div');
                item.className = 'portfolio-item';
                item.innerHTML = `
                    <label>
                        <input type="checkbox" value="${index}" checked>
                        <span>${ilan.baslik}</span>
                        <span style="font-weight:normal; color:#666; font-size:11px;">(${ilan.ozellikler['Fiyat'] || '?'})</span>
                    </label>
                    <button class="btn btn-danger" onclick="ilaniSil(${index})">Sil</button>
                `;
                listEl.appendChild(item);
            });
        }

        function ilaniSil(index) {
            globalPortfolio.splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(globalPortfolio));
            renderPortfolioList();
        }

        function havuzuTemizle() {
            if(confirm('TÃ¼m kayÄ±tlÄ± ilanlar silinecek. Emin misiniz?')) {
                globalPortfolio = [];
                localStorage.removeItem(STORAGE_KEY);
                renderPortfolioList();
                document.getElementById('reportContainer').innerHTML = '';
            }
        }

        function raporuOlustur() {
            const checkboxes = document.querySelectorAll('#portfolioList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) { alert("LÃ¼tfen listeden en az bir ilan seÃ§in."); return; }

            const selectedAds = Array.from(checkboxes).map(cb => JSON.parse(JSON.stringify(globalPortfolio[cb.value])));

            selectedAds.forEach(ad => {
                let fiyat = parseFloat((ad.ozellikler['Fiyat'] || '').replace(/\./g, '').replace(/[^0-9.]/g, ''));
                let m2 = parseFloat((ad.ozellikler['mÂ² (Net)'] || '').replace(/\./g, '').replace(/[^0-9.]/g, ''));
                
                if (!isNaN(fiyat) && !isNaN(m2) && m2 > 0) {
                    let m2Fiyat = Math.round(fiyat / m2);
                    ad.ozellikler['mÂ² FiyatÄ±'] = new Intl.NumberFormat('tr-TR').format(m2Fiyat) + " TL";
                } else {
                    ad.ozellikler['mÂ² FiyatÄ±'] = "-";
                }
            });

            const globalBestValues = calculateBestValues(selectedAds);
            const container = document.getElementById('reportContainer');
            container.innerHTML = '';

            // YENÄ°: Sayfa baÅŸÄ±na 3 ilan
            const ADS_PER_PAGE = 3; 
            const totalPages = Math.ceil(selectedAds.length / ADS_PER_PAGE);

            for (let page = 0; page < totalPages; page++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'report-page';
                
                const date = new Date().toLocaleDateString('tr-TR');
                pageDiv.innerHTML = `
                    <div style="border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:end;">
                        <div>
                            <h1 style="margin:0; font-size:20px; color:var(--primary);">GAYRÄ°MENKUL DEÄERLEME RAPORU</h1>
                            <div style="color:#7f8c8d; font-size:12px; margin-top:5px;">KARÅILAÅTIRMALI PÄ°YASA ANALÄ°ZÄ° | Sayfa ${page + 1} / ${totalPages}</div>
                        </div>
                        <div style="text-align:right; font-size:12px; color:#666;">Tarih: ${date}</div>
                    </div>
                `;

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                const startIdx = page * ADS_PER_PAGE;
                const endIdx = startIdx + ADS_PER_PAGE;
                const pageAds = selectedAds.slice(startIdx, endIdx);

                const trHead = document.createElement('tr');
                const thFeature = document.createElement('th');
                thFeature.className = 'col-feature';
                thFeature.textContent = 'Ã–ZELLÄ°KLER';
                trHead.appendChild(thFeature);

                pageAds.forEach(ilan => {
                    const th = document.createElement('th');
                    th.innerHTML = `
                        ${ilan.baslik}
                        <div class="delete-col-btn" onclick="sutunuKaldir(this)" title="SÃ¼tunu gizle">âœ•</div>
                    `;
                    trHead.appendChild(th);
                });
                thead.appendChild(trHead);
                table.appendChild(thead);

                let featureList = Object.keys(pageAds[0].ozellikler);
                featureList = featureList.filter(f => f !== 'mÂ² FiyatÄ±');
                let insertIdx = featureList.indexOf('Fiyat');
                if (insertIdx !== -1) {
                    featureList.splice(insertIdx + 1, 0, 'mÂ² FiyatÄ±');
                } else {
                    featureList.push('mÂ² FiyatÄ±');
                }

                featureList.forEach(featKey => {
                    const tr = document.createElement('tr');
                    
                    const tdLabel = document.createElement('td');
                    tdLabel.className = 'col-feature';
                    tdLabel.textContent = featKey;
                    tr.appendChild(tdLabel);

                    pageAds.forEach(ilan => {
                        const td = document.createElement('td');
                        let content = ilan.ozellikler[featKey] || '-';
                        
                        // Ä°lan No Linkleme
                        if (featKey === "Ä°lan No" && content.includes("#")) {
                            const cleanId = content.replace('#', '').trim();
                            td.innerHTML = `
                                <div>${content}</div>
                                <a href="https://www.sahibinden.com/ilan/${cleanId}/detay" target="_blank" class="ad-link">Ä°lana Git ğŸ”—</a>
                            `;
                        } else {
                            td.textContent = content;
                        }

                        // YÄ±ldÄ±zlama
                        if (featKey === 'mÂ² FiyatÄ±' && content !== '-') {
                            let val = parseFloat(content.replace(/\./g, '').replace(/[^0-9.]/g, ''));
                            if (!isNaN(val) && val === globalBestValues['mÂ² FiyatÄ±']) td.classList.add('best-price');
                        } 
                        else if (featKey === 'Bina YaÅŸÄ±' && content !== '-') {
                            let match = content.match(/\d+/);
                            if (match && parseInt(match[0]) === globalBestValues['Bina YaÅŸÄ±']) td.classList.add('best-price');
                        } 
                        else if ((featKey === 'Otopark' || featKey === 'otopark') && content !== '-') {
                            if (content.toLowerCase().includes('kapalÄ±')) td.classList.add('best-price');
                        }

                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                table.appendChild(tbody);
                pageDiv.appendChild(table);
                container.appendChild(pageDiv);

                if (page < totalPages - 1) {
                    const separator = document.createElement('div');
                    separator.className = 'page-break';
                    separator.textContent = '--- Sayfa Sonu (Bu kÄ±sÄ±m PDF\'te gÃ¶rÃ¼nmez) ---';
                    container.appendChild(separator);
                }
            }
        }

        function calculateBestValues(ads) {
            let bests = { 'mÂ² FiyatÄ±': Infinity, 'Bina YaÅŸÄ±': Infinity };
            ads.forEach(ad => {
                if (ad.ozellikler['mÂ² FiyatÄ±'] && ad.ozellikler['mÂ² FiyatÄ±'] !== '-') {
                    let val = parseFloat(ad.ozellikler['mÂ² FiyatÄ±'].replace(/\./g, '').replace(/[^0-9.]/g, ''));
                    if (!isNaN(val) && val > 0 && val < bests['mÂ² FiyatÄ±']) bests['mÂ² FiyatÄ±'] = val;
                }
                if (ad.ozellikler['Bina YaÅŸÄ±'] && ad.ozellikler['Bina YaÅŸÄ±'] !== '-') {
                    let match = ad.ozellikler['Bina YaÅŸÄ±'].match(/\d+/);
                    if (match) {
                        let yas = parseInt(match[0]);
                        if (yas < bests['Bina YaÅŸÄ±']) bests['Bina YaÅŸÄ±'] = yas;
                    }
                }
            });
            return bests;
        }

        function sutunuKaldir(btn) {
            const th = btn.parentElement;
            const cellIndex = th.cellIndex;
            const table = th.closest('table');

            const rows = table.rows;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].cells.length > cellIndex) {
                    rows[i].deleteCell(cellIndex);
                }
            }
            if (table.rows[0].cells.length === 1) {
               table.closest('.report-page').style.display = 'none';
            }
        }

        // YENÄ°: GerÃ§ek ve TÄ±klanabilir PDF OluÅŸturma Fonksiyonu
        function pdfIndir() {
            const element = document.getElementById('reportContainer');
            
            if(!element.innerHTML.trim() || element.innerHTML.includes('LÃ¼tfen yukarÄ±dan')) {
                alert("LÃ¼tfen Ã¶nce raporu oluÅŸturun.");
                return;
            }

            // Ã‡Ä±ktÄ± anÄ±nda KÄ±rmÄ±zÄ± (X) butonlarÄ±nÄ± ve Sayfa Sonu Ã§izgilerini gizle
            const deleteBtns = element.querySelectorAll('.delete-col-btn');
            const pageBreaks = element.querySelectorAll('.page-break');
            deleteBtns.forEach(btn => btn.style.display = 'none');
            pageBreaks.forEach(pb => pb.style.display = 'none');

            // KÃ¼tÃ¼phane AyarlarÄ±
            const opt = {
                margin:       [10, 5, 10, 5], // Ãœst, Sol, Alt, SaÄŸ boÅŸluklar (mm)
                filename:     'Emlak_Degerleme_Raporu.pdf',
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { scale: 2, useCORS: true }, // scale: 2 yÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼k saÄŸlar
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }, // Dikey Format
                pagebreak:    { mode: 'css', avoid: 'tr' } // CSS'teki page-break ayarlarÄ±nÄ± anlar
            };

            // PDF'i oluÅŸtur ve indir, ardÄ±ndan butonlarÄ± geri getir
            html2pdf().set(opt).from(element).save().then(() => {
                deleteBtns.forEach(btn => btn.style.display = 'flex');
                pageBreaks.forEach(pb => pb.style.display = 'block');
            });
        }
    </script>
</body>
</html>
