<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak Raporu Final</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --green: #27ae60;
            --blue: #3498db;
            --bg: #f5f6fa;
        }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; }

        /* Panel */
        .panel { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 1200px; margin: 0 auto 20px auto; }
        textarea { width: 100%; height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-sizing: border-box; }
        
        .btn { border: none; padding: 10px 20px; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-add { background: var(--primary); }
        .btn-clear { background: #c0392b; }
        .btn-report { background: var(--green); }
        .btn-print { background: var(--blue); }

        .list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .item { background: white; border: 1px solid #ddd; padding: 8px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }

        /* Rapor */
        .report-page { background: white; width: 100%; max-width: 297mm; min-height: 190mm; margin: 0 auto 30px auto; padding: 10mm; box-sizing: border-box; }
        .table-wrap { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 800px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; word-wrap: break-word; }
        
        .col-head { background: var(--primary); color: white; width: 140px; text-align: left; padding-left: 10px; font-weight: bold; position: sticky; left: 0; }
        thead th { background: var(--secondary); color: white; height: 40px; }

        /* --- KESƒ∞N KURALLAR --- */
        
        /* 1. MAVƒ∞ BUTON TASARIMI */
        .go-btn {
            display: inline-block; 
            background-color: var(--blue); 
            color: white !important;
            text-decoration: none; 
            padding: 8px 15px; 
            border-radius: 20px; 
            margin-top: 5px;
            font-size: 11px; 
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            width: 80%;
        }

        /* 2. YE≈ûƒ∞L VURGULAMA (Tek Tip) */
        .winner {
            background-color: #d1f2eb !important;
            color: #006266 !important;
            font-weight: 900 !important;
            border: 2px solid #009432 !important;
        }
        .badge { display: block; font-size: 9px; color: #009432; margin-bottom: 2px; }

        /* Sƒ∞LME BUTONU */
        .del-col { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; border: 1px solid white; }

        @media print {
            .panel, .del-col { display: none !important; }
            .report-page { margin: 0; box-shadow: none; width: 100%; max-width: 100%; padding: 5mm; }
            .go-btn { background: transparent; color: var(--primary) !important; border: 1px solid var(--primary); box-shadow: none; }
            .winner { background-color: #f0fff4 !important; border-width: 1px; }
            @page { size: A4 landscape; margin: 0; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div class="panel">
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
        <div style="flex:1;">
            <h3>1. Veri Giri≈üi</h3>
            <textarea id="jsonInput" placeholder="JSON kodunu buraya yapƒ±≈ütƒ±rƒ±n..."></textarea>
            <div style="margin-top:5px;">
                <button class="btn btn-add" onclick="add()">Ekle</button>
                <span id="msg" style="color:green; font-size:12px;"></span>
            </div>
        </div>
        <div style="flex:1;">
            <div style="display:flex; justify-content:space-between;"><h3>2. Liste</h3> <button class="btn btn-clear" onclick="clearAll()">Temizle</button></div>
            <div id="list" class="list"></div>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn btn-report" onclick="render()">Raporla</button>
                <button class="btn btn-print" onclick="window.print()">Yazdƒ±r</button>
            </div>
        </div>
    </div>
</div>

<div id="container"></div>

<script>
    let ads = [];
    const KEY = 'emlak_v13_final';

    window.onload = () => {
        let s = localStorage.getItem(KEY);
        if(s) { ads = JSON.parse(s); list(); }
    }

    // --- PARSING (Sayƒ±larƒ± Temizleme) ---
    function getNum(v) {
        if(!v) return 0;
        // 1.250.000 -> 1250000 | 1.250,50 -> 1250.50
        let s = v.toString().replace(/\./g,'').replace(/,/g,'.');
        let m = s.match(/[0-9.]+/);
        return m ? parseFloat(m[0]) : 0;
    }

    function getAge(v) {
        if(!v) return 999;
        let s = v.toString().toLowerCase();
        if(s.includes('sƒ±fƒ±r')||s.includes('yeni')||s.includes('0')) return 0;
        let m = s.match(/\d+/);
        return m ? parseInt(m[0]) : 999;
    }

    // --- VERƒ∞ EKLEME ---
    function add() {
        try {
            const data = JSON.parse(document.getElementById('jsonInput').value);
            Object.keys(data.basliklar).forEach(k => {
                let item = { title: data.basliklar[k], feats: {} };
                data.satirlar.forEach(r => { item.feats[r.ozellik.trim()] = r[k] || '-'; });
                ads.push(item);
            });
            save();
            document.getElementById('jsonInput').value = '';
            document.getElementById('msg').innerText = "Eklendi.";
        } catch(e) { alert("JSON Hatasƒ±"); }
    }

    function list() {
        const d = document.getElementById('list'); d.innerHTML='';
        ads.forEach((a,i) => {
            d.innerHTML += `<div class="item"><label><input type="checkbox" value="${i}" checked> ${a.title}</label> <button onclick="del(${i})" style="color:red;border:none;background:none;cursor:pointer;">‚úï</button></div>`;
        });
    }

    function del(i) { ads.splice(i,1); save(); }
    function clearAll() { if(confirm("Silinsin mi?")){ ads=[]; save(); document.getElementById('container').innerHTML=''; } }
    function save() { localStorage.setItem(KEY, JSON.stringify(ads)); list(); }

    // --- RAPORLAMA ---
    function render() {
        const sel = Array.from(document.querySelectorAll('#list input:checked')).map(cb=>ads[cb.value]);
        if(sel.length===0) return alert("Se√ßim yapƒ±n");

        // 1. ANALƒ∞Z: EN ƒ∞Yƒ∞LERƒ∞ BUL
        let stats = { minPrice: Infinity, minUnit: Infinity, maxNet: 0, minAge: 999 };

        sel.forEach(ad => {
            for(let [k, v] of Object.entries(ad.feats)) {
                let key = k.toLowerCase();
                let n = getNum(v);

                // Fiyat
                if(k === 'Fiyat' && n > 0 && n < stats.minPrice) stats.minPrice = n;
                
                // Birim Fiyat
                if(key.includes('birim') && n > 0 && n < stats.minUnit) stats.minUnit = n;
                
                // Net m2 (Slash'ƒ±n saƒüƒ±)
                if(key.includes('m¬≤') || key.includes('metrekare') || key.includes('m2')) {
                    let net = n;
                    if(v.includes('/')) {
                        let parts = v.split('/');
                        let right = getNum(parts[1]); 
                        if(right > 0) net = right; // Saƒü taraf varsa onu al
                    }
                    if(net > stats.maxNet) stats.maxNet = net;
                }
                
                // Ya≈ü
                if((key.includes('ya≈ü') || key.includes('bina')) && getAge(v) < stats.minAge) stats.minAge = getAge(v);
            }
        });

        // 2. √áƒ∞Zƒ∞M
        const con = document.getElementById('container'); con.innerHTML = '';
        const perPage = 6;
        const pages = Math.ceil(sel.length/perPage);

        for(let p=0; p<pages; p++) {
            const batch = sel.slice(p*perPage, (p+1)*perPage);
            let h = `<div class="report-page">
                <div style="border-bottom:3px solid var(--primary); padding-bottom:10px; margin-bottom:20px; display:flex; justify-content:space-between;">
                    <h2 style="margin:0; color:var(--primary);">DEƒûERLEME RAPORU</h2>
                    <small>Sayfa ${p+1}/${pages}</small>
                </div>
                <div class="table-wrap">
                <table><thead><tr><th class="col-head">√ñZELLƒ∞KLER</th>`;
            
            batch.forEach(a => h += `<th>${a.title} <div class="del-col" onclick="remCol(this)">‚úï</div></th>`);
            h += `</tr></thead><tbody>`;

            if(batch.length > 0) {
                Object.keys(batch[0].feats).forEach(feat => {
                    h += `<tr><td class="col-head">${feat}</td>`;
                    
                    batch.forEach(ad => {
                        let val = ad.feats[feat];
                        let key = feat.toLowerCase();
                        let num = getNum(val);
                        let cls = ''; let badge = '';

                        // --- RENKLENDƒ∞RME ---
                        // Fiyat
                        if(feat === 'Fiyat' && num === stats.minPrice) { 
                            cls = 'winner'; badge = '<span class="badge">üìâ EN UYGUN</span>'; 
                        }
                        // Birim Fiyat
                        else if(key.includes('birim') && num === stats.minUnit) { 
                            cls = 'winner'; badge = '<span class="badge">üíé FIRSAT</span>'; 
                        }
                        // Net m2
                        else if(key.includes('m¬≤') || key.includes('metrekare') || key.includes('m2')) {
                            let net = num;
                            if(val.includes('/')) { let r = getNum(val.split('/')[1]); if(r>0) net = r; }
                            if(net === stats.maxNet && net > 0) { 
                                cls = 'winner'; badge = '<span class="badge">üìê EN GENƒ∞≈û</span>'; 
                            }
                        }
                        // Ya≈ü
                        else if((key.includes('ya≈ü') || key.includes('bina')) && getAge(val) === stats.minAge) { 
                            cls = 'winner'; badge = '<span class="badge">üÜï EN YENƒ∞</span>'; 
                        }

                        // --- BUTON YAPICI ---
                        let content = val;
                        if(key.includes('ilan no')) {
                            let id = val.replace(/[^0-9]/g, '');
                            // Link varsa veya ID uzunsa buton bas
                            content = `<div style="font-weight:bold; color:#555;">${val}</div>`;
                            if(id.length > 5) {
                                content += `<a href="https://www.sahibinden.com/ilan/${id}/detay" target="_blank" class="go-btn">ƒ∞lana Git üîó</a>`;
                            }
                        }

                        h += `<td class="${cls}">${badge}${content}</td>`;
                    });
                    h += `</tr>`;
                });
            }
            h += `</tbody></table></div></div>`;
            con.innerHTML += h;
        }
    }

    function remCol(btn) {
        let idx = btn.parentElement.cellIndex;
        let tbl = btn.closest('table');
        Array.from(tbl.rows).forEach(r => r.deleteCell(idx));
    }
</script>
</body>
</html>
